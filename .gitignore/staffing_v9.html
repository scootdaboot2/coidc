<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Central Oregon Staffing</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f8f8;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .main-content {
      display: flex;
      gap: 20px;
    }
    .division-column {
      flex: 3;
    }
    .aviation-column {
      flex: 1;
    }
    .division-section, .aviation-table-section {
      margin-bottom: 30px;
      background: #fff;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .division-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    .division-meta {
      font-size: 0.8em;
      text-align: right;
      line-height: 1.4;
      color: #666;
    }
    .duty-info {
      margin: 10px 0;
      padding: 8px;
      background: #f9f9f9;
      border-left: 4px solid #2196f3;
      font-size: 0.9em;
    }
    .division-table, .aviation-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .division-table th, .division-table td,
    .aviation-table th, .aviation-table td {
      border: 1px solid #ddd;
      padding: 8px 10px;
      text-align: left;
    }
    .division-table th, .aviation-table th {
      background-color: #f5f5f5;
      font-weight: bold;
    }
    .btn.update-btn {
      padding: 4px 8px;
      background: #ddd;
      color: #666;
      border: none;
      cursor: pointer;
      border-radius: 3px;
      font-size: 11px;
      margin-top: 5px;
    }
    .btn.update-btn:hover {
      background: #ccc;
    }
    .edit-input, .edit-select {
      width: 100%;
      box-sizing: border-box;
      padding: 4px;
      border: 1px solid #ccc;
    }
    .add-btn, .save-btn {
      background: #2e7d32;
      color: #fff;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      margin: 6px 4px 6px 0;
      border-radius: 3px;
    }
    .add-btn:hover, .save-btn:hover {
      background: #1b5e20;
    }
    .delete-btn {
      background: #c62828;
      color: #fff;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 3px;
    }
    .delete-btn:hover {
      background: #8e0000;
    }
    .status-late {
      background-color: #ffebee !important;
      color: #c62828;
      font-weight: bold;
    }
    .status-out {
      color: #666;
      font-style: italic;
    }
    .status-committed {
      background-color: #fff3e0 !important;
      color: #ef6c00;
    }
    .status-delayed {
      background-color: #fff8e1 !important;
      color: #f57c00;
    }
    .csv-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: none;
    }
    .csv-controls.show {
      display: block;
    }
    .csv-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 4px;
    }
    .csv-btn {
      padding: 4px 8px;
      font-size: 11px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      white-space: nowrap;
    }
    .csv-btn.download {
      background: #4caf50;
      color: white;
    }
    .csv-btn.upload {
      background: #2196f3;
      color: white;
    }
    .csv-btn:hover {
      opacity: 0.8;
    }
    .filter-controls {
      margin: 10px 0;
    }
    .filter-controls label {
      margin-right: 15px;
    }
    .cofms-header {
      background: #e3f2fd;
      border: 2px solid #1976d2;
      text-align: center;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 5px;
    }
    .cofms-header h2 {
      margin: 0 0 10px 0;
      color: #1976d2;
    }
    .data-management-btn {
      background: #ff9800;
      color: white;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 3px;
      margin: 6px 4px;
    }
    .data-management-btn:hover {
      background: #f57c00;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 1200px;
      border-radius: 5px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .modal-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    .modal-table th, .modal-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .modal-table th {
      background-color: #f2f2f2;
    }
    .filter-input {
      margin: 5px;
      padding: 4px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Central Oregon Staffing</h1>
  
  <div class="csv-controls" id="csvControls">
    <div class="csv-buttons">
      <button class="csv-btn download" onclick="downloadCSV('individuals')">↓ Individuals</button>
      <button class="csv-btn download" onclick="downloadCSV('resources')">↓ Resources</button>
      <button class="csv-btn download" onclick="downloadCSV('aviation')">↓ Aviation</button>
      <input type="file" id="uploadIndividuals" style="display:none" accept=".csv" onchange="uploadCSV(event, 'individuals')">
      <button class="csv-btn upload" onclick="document.getElementById('uploadIndividuals').click()">↑ Individuals</button>
      <input type="file" id="uploadResources" style="display:none" accept=".csv" onchange="uploadCSV(event, 'resources')">
      <button class="csv-btn upload" onclick="document.getElementById('uploadResources').click()">↑ Resources</button>
      <input type="file" id="uploadAviation" style="display:none" accept=".csv" onchange="uploadCSV(event, 'aviation')">
      <button class="csv-btn upload" onclick="document.getElementById('uploadAviation').click()">↑ Aviation</button>
    </div>
  </div>
  
  <div class="cofms-header">
    <h2>COFMS Duty Officer</h2>
    <div id="cofms-duty-officer">Loading...</div>
  </div>

  <div class="filter-controls">
    <label><input type="checkbox" id="filterOutOfService" checked> Hide Out of Service</label>
    <label><input type="checkbox" id="filterOffForest"> Hide Off Forest</label>
    <button class="update-btn" onclick="renderPage()">Apply Filters</button>
  </div>

  <div class="main-content">
    <div id="staffing-container" class="division-column"></div>
    <div id="aviation-container" class="aviation-column"></div>
  </div>

  <!-- Data Management Modals -->
  <div id="individualsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('individualsModal')">&times;</span>
      <h2>Manage Individuals</h2>
      <button class="add-btn" onclick="addIndividualRow()">Add New Individual</button>
      <button class="save-btn" onclick="saveIndividuals()">Save Changes</button>
      <div id="individualsTable"></div>
    </div>
  </div>

  <div id="resourcesModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('resourcesModal')">&times;</span>
      <h2>Manage Resources</h2>
      <button class="add-btn" onclick="addResourceRow()">Add New Resource</button>
      <button class="save-btn" onclick="saveResources()">Save Changes</button>
      <div id="resourcesTable"></div>
    </div>
  </div>

  <div id="aviationModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('aviationModal')">&times;</span>
      <h2>Manage Aviation</h2>
      <button class="add-btn" onclick="addAviationRow()">Add New Aircraft</button>
      <button class="save-btn" onclick="saveAviation()">Save Changes</button>
      <div id="aviationTable"></div>
    </div>
  </div>

  <script>
    // Global edit state
    let isEditMode = false;

    // Data storage
    let individualData = [
      {
        "First": "Jane",
        "Last": "Smith",
        "Phone": "541-555-1234",
        "Phone2": "541-555-5678",
        "Email": "jane.smith@example.com",
        "Agency": "USFS",
        "Unit": "COFMS",
        "Location": "Cascade Division",
        "Title": "USFS-IC",
        "ICSRole": "AA",
        "AssignedTo": "OR-DEF-BC41",
        "Lead": "Yes",
        "Remarks": ""
      }
    ];

    let resourceData = [
      {
        "ResourceType": "Duty Officer",
        "ResourceName": "OR-DEF-BC41",
        "Leader": "Jane Smith",
        "Assigned": 1,
        "Status": "In Service",
        "Location": "Cascade Division",
        "Remarks": "Covering east side"
      }
    ];

    let aviationData = {
      "Rotor Wing": [
        {
          "Type": "HEL T1",
          "Resource": "N1234H",
          "Status": "Available",
          "Location": "Redmond",
          "OnOff": "0800-2000"
        }
      ],
      "Fixed Wing": [
        {
          "Type": "SEAT",
          "Resource": "N5678F",
          "Status": "Unavailable",
          "Location": "Prineville",
          "OnOff": "0800-2000"
        }
      ]
    };

    // Configuration arrays
    const divisions = [
      "Cascade Division", "Crescent Division", "Newberry East", "Newberry West", 
      "Rivers Division", "Prairie Division", "ODF Prineville", "ODF Sisters", "ODF Fossil"
    ];

    const agencies = ["USFS", "BLM", "ODF"];
    
    const units = [
      "Prineville FO", "Deschutes FO", "Central Oregon", "DEF-Bend", "DEF-Sisters", 
      "DEF-Crescent", "OCF-Prineville", "COFMS"
    ];

    const locations = [
      "Cascade", "Crescent", "Newberry East", "Newberry West", "Rivers", "Prairie", 
      "ODF Sisters", "ODF Prineville", "ODF Fossil", "ODF John Day", "BIAK", "Walker Range"
    ];

    const titles = [
      "BLM-Prineville District Manager", "BLM-Deschutes Field Manager", 
      "BLM-Central Oregon Manager", "USFS-IC", "FMO", "BC", "Operations"
    ];

    const icsRoles = ["FFT1", "FFT2", "TFLD", "DIVS", "AA", "AR"];

    const resourceTypes = [
      "Duty Officer", "Overhead (FMO)", "Overhead (FT)", "Overhead (BC)", "Prevention", 
      "Lookout", "ENG T3", "ENG T5", "ENG T6", "Overhead (FOS)", "CRWT2 IA", "CRWT2", 
      "IHC", "WFMT1", "WFMT2", "HEL T1", "HEL T2", "HEL T3", "DOZ T1", "DOZ T2", 
      "DOZ T3", "WTS T1", "WTS T2", "WTS T3", "IA MOD", "Severity", "Support"
    ];

    const statuses = ["In Service", "Delayed Response", "Out of Service", "Off Forest", "Late Resource", "Committed"];

    // Helper functions
    function createSelectOptions(array, selected = '', allowCustom = false) {
      let options = array.map(item => 
        `<option value="${item}" ${item === selected ? 'selected' : ''}>${item}</option>`
      ).join('');
      
      if (allowCustom && selected && !array.includes(selected)) {
        options += `<option value="${selected}" selected>${selected}</option>`;
      }
      
      return options;
    }

    function createEditableSelect(array, selected = '', allowCustom = false) {
      if (allowCustom) {
        return `<input class="edit-input" list="datalist_${Math.random().toString(36).substr(2, 9)}" value="${selected}">
                <datalist id="datalist_${Math.random().toString(36).substr(2, 9)}">
                  ${array.map(item => `<option value="${item}">`).join('')}
                </datalist>`;
      } else {
        return `<select class="edit-select">${createSelectOptions(array, selected)}</select>`;
      }
    }

    function getStatusClass(status) {
      switch(status) {
        case 'Late Resource': return 'status-late';
        case 'Out of Service': return 'status-out';
        case 'Committed': return 'status-committed';
        case 'Delayed Response': return 'status-delayed';
        default: return '';
      }
    }

    function sortResourcesByStatus(resources) {
      const statusOrder = ['Late Resource', 'In Service', 'Delayed Response', 'Committed', 'Off Forest', 'Out of Service'];
      return resources.sort((a, b) => {
        const aIndex = statusOrder.indexOf(a.Status) === -1 ? 999 : statusOrder.indexOf(a.Status);
        const bIndex = statusOrder.indexOf(b.Status) === -1 ? 999 : statusOrder.indexOf(b.Status);
        return aIndex - bIndex;
      });
    }

    function shouldShowResource(resource) {
      const hideOutOfService = document.getElementById('filterOutOfService').checked;
      const hideOffForest = document.getElementById('filterOffForest').checked;
      
      if (hideOutOfService && resource.Status === 'Out of Service') return false;
      if (hideOffForest && resource.Status === 'Off Forest') return false;
      return true;
    }

    // Auto-population functions
    function getIndividualByName(name) {
      return individualData.find(person => `${person.First} ${person.Last}` === name);
    }

    function getResourceByName(name) {
      return resourceData.find(resource => resource.ResourceName === name);
    }

    function populateFromIndividual(row, individual) {
      if (!individual) return;
      
      const locationSelect = row.querySelector('select:nth-of-type(4)'); // Location select
      if (locationSelect && individual.Location) {
        locationSelect.value = individual.Location;
      }
    }

    function populateFromResource(row, resource) {
      if (!resource) return;
      
      const typeSelect = row.querySelector('select:nth-of-type(1)');
      const assignedInput = row.querySelector('input[type="number"]');
      const statusSelect = row.querySelector('select:nth-of-type(3)');
      const locationSelect = row.querySelector('select:nth-of-type(4)');
      const remarksInput = row.querySelector('input:last-of-type');
      
      if (typeSelect && resource.ResourceType) typeSelect.value = resource.ResourceType;
      if (assignedInput && resource.Assigned) assignedInput.value = resource.Assigned;
      if (statusSelect && resource.Status) statusSelect.value = resource.Status;
      if (locationSelect && resource.Location) locationSelect.value = resource.Location;
      if (remarksInput && resource.Remarks) remarksInput.value = resource.Remarks;
    }

    // Data transformation
    function getStaffingData() {
      const divisionMap = new Map();
      
      // Initialize all divisions
      divisions.forEach(divName => {
        divisionMap.set(divName, {
          name: divName,
          dutyOfficer: '',
          agencyAdmins: [],
          lastModified: new Date().toLocaleString(),
          resources: []
        });
      });
      
      // Add individuals to divisions
      individualData.forEach(person => {
        const location = person.Location || 'Unassigned';
        const divName = divisions.find(d => d.includes(location)) || location;
        
        if (!divisionMap.has(divName)) {
          divisionMap.set(divName, {
            name: divName,
            dutyOfficer: '',
            agencyAdmins: [],
            lastModified: new Date().toLocaleString(),
            resources: []
          });
        }
        
        const division = divisionMap.get(divName);
        if (person.ICSRole === 'AA' || person.ICSRole === 'AR') {
          division.agencyAdmins.push(`${person.First} ${person.Last} (${person.Phone}${person.Phone2 ? ' / ' + person.Phone2 : ''}, ${person.Email})`);
        }
      });

      // Add resources to divisions and find duty officers
      resourceData.forEach(resource => {
        const location = resource.Location || 'Unassigned';
        const divName = divisions.find(d => d.includes(location)) || location;
        
        if (divisionMap.has(divName)) {
          const division = divisionMap.get(divName);
          division.resources.push({
            type: resource.ResourceType,
            name: resource.ResourceName,
            leader: resource.Leader,
            assigned: resource.Assigned,
            status: resource.Status,
            location: resource.Location,
            remarks: resource.Remarks
          });
          
          if (resource.ResourceType === 'Duty Officer') {
            division.dutyOfficer = resource.Leader;
          }
        }
      });

      // Sort resources by status for each division
      divisionMap.forEach(division => {
        division.resources = sortResourcesByStatus(division.resources);
      });

      return Array.from(divisionMap.values());
    }

    function getCOFMSDutyOfficer() {
      const cofmsResource = resourceData.find(r => 
        r.ResourceType === 'Duty Officer' && r.ResourceName.includes('COFMS')
      );
      
      if (cofmsResource) {
        const individual = individualData.find(i => 
          `${i.First} ${i.Last}` === cofmsResource.Leader
        );
        if (individual) {
          return `${individual.First} ${individual.Last}<br>Phone: ${individual.Phone}${individual.Phone2 ? ' / ' + individual.Phone2 : ''}<br>Email: ${individual.Email}`;
        }
        return cofmsResource.Leader;
      }
      return 'None Assigned';
    }

    // CSV handling functions
    function downloadCSV(type) {
      let rows = [];
      let filename = '';
      
      switch(type) {
        case 'individuals':
          rows.push(['First', 'Last', 'Phone', 'Phone2', 'Email', 'Agency', 'Unit', 'Location', 'Title', 'ICSRole', 'AssignedTo', 'Lead', 'Remarks']);
          individualData.forEach(person => {
            rows.push([
              person.First || '', person.Last || '', person.Phone || '', person.Phone2 || '',
              person.Email || '', person.Agency || '', person.Unit || '', person.Location || '',
              person.Title || '', person.ICSRole || '', person.AssignedTo || '', person.Lead || '', person.Remarks || ''
            ]);
          });
          filename = 'individuals.csv';
          break;
          
        case 'resources':
          rows.push(['ResourceType', 'ResourceName', 'Leader', 'Assigned', 'Status', 'Location', 'Remarks']);
          resourceData.forEach(resource => {
            rows.push([
              resource.ResourceType || '', resource.ResourceName || '', resource.Leader || '',
              resource.Assigned || '', resource.Status || '', resource.Location || '', resource.Remarks || ''
            ]);
          });
          filename = 'resources.csv';
          break;
          
        case 'aviation':
          rows.push(['Type', 'Resource', 'Status', 'Location', 'OnOff']);
          Object.entries(aviationData).forEach(([type, resources]) => {
            resources.forEach(resource => {
              rows.push([type, resource.Resource || '', resource.Status || '', resource.Location || '', resource.OnOff || '']);
            });
          });
          filename = 'aviation.csv';
          break;
      }
      
      const csv = rows.map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
      ).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function uploadCSV(event, type) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.trim().split('\n');
          const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
          
          const newData = [];
          for (let i = 1; i < lines.length; i++) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            // Parse CSV properly handling quoted values
            for (let j = 0; j < lines[i].length; j++) {
              const char = lines[i][j];
              if (char === '"') {
                inQuotes = !inQuotes;
              } else if (char === ',' && !inQuotes) {
                values.push(current.trim());
                current = '';
              } else {
                current += char;
              }
            }
            values.push(current.trim()); // Add the last value
            
            const row = {};
            headers.forEach((header, index) => {
              row[header] = values[index] ? values[index].replace(/^"|"$/g, '') : '';
            });
            newData.push(row);
          }
          
          switch(type) {
            case 'individuals':
              individualData = newData;
              break;
            case 'resources':
              resourceData = newData;
              break;
            case 'aviation':
              // Convert flat CSV back to nested structure
              const newAviationData = { "Rotor Wing": [], "Fixed Wing": [] };
              newData.forEach(row => {
                const aviationItem = {
                  Resource: row.Resource || '',
                  Status: row.Status || '',
                  Location: row.Location || '',
                  OnOff: row.OnOff || ''
                };
                
                if (row.Type === 'Rotor Wing') {
                  aviationItem.Type = 'HEL T1';
                  newAviationData["Rotor Wing"].push(aviationItem);
                } else if (row.Type === 'Fixed Wing') {
                  aviationItem.Type = 'SEAT';
                  newAviationData["Fixed Wing"].push(aviationItem);
                }
              });
              aviationData = newAviationData;
              break;
          }
          
          renderPage();
          alert(`${type} CSV loaded successfully!`);
        } catch (error) {
          alert(`Error loading ${type} CSV: ${error.message}`);
        }
      };
      reader.readAsText(file);
    }

    // Edit functions
    function toggleEditMode() {
      isEditMode = !isEditMode;
      const csvControls = document.getElementById('csvControls');
      if (isEditMode) {
        csvControls.classList.add('show');
      } else {
        csvControls.classList.remove('show');
      }
    }

    function createEditableRow(resource) {
      const resourceNames = resourceData.map(r => r.ResourceName);
      const leaders = individualData.map(i => `${i.First} ${i.Last}`);
      
      return `
        <tr>
          <td><select class="edit-select">${createSelectOptions(resourceTypes, resource.type, true)}</select></td>
          <td>
            <select class="edit-select" onchange="handleResourceNameChange(this)">
              <option value="">New Resource</option>
              ${createSelectOptions(resourceNames, resource.name)}
            </select>
            <input class="edit-input" value="${resource.name}" style="margin-top: 2px;" placeholder="Resource Name">
          </td>
          <td><select class="edit-select" onchange="handleLeaderChange(this)">${createSelectOptions(leaders, resource.leader)}</select></td>
          <td><input class="edit-input" type="number" value="${resource.assigned}" /></td>
          <td><select class="edit-select">${createSelectOptions(statuses, resource.status)}</select></td>
          <td><input class="edit-input" list="locationsList" value="${resource.location}">
              <datalist id="locationsList">${locations.map(loc => `<option value="${loc}">`).join('')}</datalist></td>
          <td><input class="edit-input" value="${resource.remarks}" /></td>
          <td><button class="delete-btn" onclick="this.closest('tr').remove()">✖</button></td>
        </tr>
      `;
    }

    function handleLeaderChange(select) {
      const row = select.closest('tr');
      const leaderName = select.value;
      const individual = getIndividualByName(leaderName);
      if (individual) {
        populateFromIndividual(row, individual);
      }
    }

    function handleResourceNameChange(select) {
      const row = select.closest('tr');
      const resourceName = select.value;
      const nameInput = row.querySelector('input[placeholder="Resource Name"]');
      
      if (resourceName) {
        nameInput.value = resourceName;
        const resource = getResourceByName(resourceName);
        if (resource) {
          populateFromResource(row, resource);
        }
      }
    }

    function toggleDivisionEdit(div, divisionData) {
      toggleEditMode();
      
      const table = div.querySelector('table');
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = divisionData.resources.map(res => createEditableRow(res)).join('');

      const addBtn = document.createElement('button');
      addBtn.className = 'add-btn';
      addBtn.textContent = '+ Add Resource';
      addBtn.onclick = () => {
        const tr = document.createElement('tr');
        tr.innerHTML = createEditableRow({ type: '', name: '', leader: '', assigned: 1, status: 'In Service', location: divisionData.name, remarks: '' });
        tbody.appendChild(tr);
      };

      const dataManageBtn = document.createElement('button');
      dataManageBtn.className = 'data-management-btn';
      dataManageBtn.textContent = 'Manage Data';
      dataManageBtn.onclick = () => showDataManagement();

      const aviationManageBtn = document.createElement('button');
      aviationManageBtn.className = 'data-management-btn';
      aviationManageBtn.textContent = 'Aviation';
      aviationManageBtn.onclick = () => toggleAviationEdit();

      const prevAdd = div.querySelector('.add-btn');
      if (prevAdd) prevAdd.remove();
      const prevDataManage = div.querySelector('.data-management-btn');
      if (prevDataManage) prevDataManage.remove();
      
      table.insertAdjacentElement('beforebegin', addBtn);
      table.insertAdjacentElement('beforebegin', dataManageBtn);
      table.insertAdjacentElement('beforebegin', aviationManageBtn);
      
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save-btn';
      saveBtn.textContent = 'Save Section';
      saveBtn.onclick = () => {
        const updatedRows = [];
        tbody.querySelectorAll('tr').forEach(row => {
          const selects = row.querySelectorAll('select');
          const inputs = row.querySelectorAll('input');
          if (selects.length && inputs.length) {
            const nameInput = row.querySelector('input[placeholder="Resource Name"]');
            updatedRows.push({
              type: selects[0].value,
              name: nameInput.value,
              leader: selects[2].value,
              assigned: parseInt(inputs[1].value) || 1,
              status: selects[3].value,
              location: inputs[2].value,
              remarks: inputs[3].value
            });
          }
        });

        // Update resourceData
        resourceData = resourceData.filter(r => r.Location !== divisionData.name);
        updatedRows.forEach(row => {
          if (row.name) {
            resourceData.push({
              ResourceType: row.type,
              ResourceName: row.name,
              Leader: row.leader,
              Assigned: row.assigned,
              Status: row.status,
              Location: row.location,
              Remarks: row.remarks
            });
          }
        });

        renderPage();
        alert('Division saved! Use "↓ Resources" to download updated CSV.');
      };

      div.appendChild(saveBtn);
    }

    // Aviation edit functions
    function createEditableAviationRow(resource) {
      return `
        <tr>
          <td><select class="edit-select">${createSelectOptions(['Rotor Wing', 'Fixed Wing'], resource.type)}</select></td>
          <td><input class="edit-input" value="${resource.resource}" /></td>
          <td><select class="edit-select">${createSelectOptions(['Available', 'Unavailable', 'Committed', 'Out of Service'], resource.status)}</select></td>
          <td><input class="edit-input" list="locationsList" value="${resource.location}">
              <datalist id="locationsList">${locations.map(loc => `<option value="${loc}">`).join('')}</datalist></td>
          <td><input class="edit-input" value="${resource.onoff}" placeholder="0800-2000" /></td>
          <td><button class="delete-btn" onclick="this.closest('tr').remove()">✖</button></td>
        </tr>
      `;
    }

    function toggleAviationEdit() {
      const aviationEl = document.getElementById('aviation-container');
      aviationEl.innerHTML = '';

      const section = document.createElement('div');
      section.className = 'aviation-section';
      section.innerHTML = '<h2>Aviation Resources (Edit Mode)</h2>';

      const aviationResources = [];
      Object.entries(aviationData).forEach(([type, resources]) => {
        resources.forEach(resource => {
          aviationResources.push({
            type: type,
            resource: resource.Resource,
            status: resource.Status,
            location: resource.Location,
            onoff: resource.OnOff
          });
        });
      });
      
      ['Rotor Wing', 'Fixed Wing'].forEach(type => {
        const data = aviationResources.filter(r => r.type === type);
        const wrapper = document.createElement('div');
        wrapper.className = 'aviation-table-section';

        const table = document.createElement('table');
        table.className = 'aviation-table';
        table.innerHTML = `
          <thead><tr><th colspan="6">${type}</th></tr>
          <tr><th>Type</th><th>Resource</th><th>Status</th><th>Location</th><th>On/Off</th><th></th></tr></thead>
          <tbody>
            ${data.map(row => createEditableAviationRow(row)).join('')}
          </tbody>
        `;

        const addBtn = document.createElement('button');
        addBtn.className = 'add-btn';
        addBtn.textContent = `+ Add ${type}`;
        addBtn.onclick = () => {
          const tr = document.createElement('tr');
          tr.innerHTML = createEditableAviationRow({ type: type, resource: '', status: 'Available', location: 'Redmond', onoff: '0800-2000' });
          table.querySelector('tbody').appendChild(tr);
        };

        wrapper.appendChild(addBtn);
        wrapper.appendChild(table);
        section.appendChild(wrapper);
      });

      const saveBtn = document.createElement('button');
      saveBtn.className = 'save-btn';
      saveBtn.textContent = 'Save Aviation';
      saveBtn.onclick = () => {
        const newAviationData = { "Rotor Wing": [], "Fixed Wing": [] };
        
        section.querySelectorAll('tbody tr').forEach(row => {
          const selects = row.querySelectorAll('select');
          const inputs = row.querySelectorAll('input');
          if (selects.length && inputs.length && inputs[0].value) {
            const type = selects[0].value;
            const resource = {
              Type: type === 'Rotor Wing' ? 'HEL T1' : 'SEAT',
              Resource: inputs[0].value,
              Status: selects[1].value,
              Location: inputs[1].value,
              OnOff: inputs[2].value
            };
            
            if (type === 'Rotor Wing') {
              newAviationData["Rotor Wing"].push(resource);
            } else {
              newAviationData["Fixed Wing"].push(resource);
            }
          }
        });

        aviationData = newAviationData;
        renderPage();
        alert('Aviation saved! Use "↓ Aviation" to download updated CSV.');
      };

      section.appendChild(saveBtn);
      aviationEl.appendChild(section);
    }

    // Data Management Modal Functions
    function showDataManagement() {
      // Show all three modals with tabs or buttons to switch between them
      openModal('individualsModal');
      loadIndividualsTable();
    }

    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function loadIndividualsTable() {
      const container = document.getElementById('individualsTable');
      let html = `
        <table class="modal-table">
          <thead>
            <tr>
              <th>First</th><th>Last</th><th>Phone</th><th>Phone2</th><th>Email</th>
              <th>Agency</th><th>Unit</th><th>Location</th><th>Title</th><th>ICS Role</th>
              <th>Assigned To</th><th>Lead</th><th>Remarks</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      individualData.forEach((person, index) => {
        html += `
          <tr>
            <td><input class="filter-input" value="${person.First || ''}" onchange="updateIndividual(${index}, 'First', this.value)"></td>
            <td><input class="filter-input" value="${person.Last || ''}" onchange="updateIndividual(${index}, 'Last', this.value)"></td>
            <td><input class="filter-input" value="${person.Phone || ''}" onchange="updateIndividual(${index}, 'Phone', this.value)"></td>
            <td><input class="filter-input" value="${person.Phone2 || ''}" onchange="updateIndividual(${index}, 'Phone2', this.value)"></td>
            <td><input class="filter-input" value="${person.Email || ''}" onchange="updateIndividual(${index}, 'Email', this.value)"></td>
            <td><select class="filter-input" onchange="updateIndividual(${index}, 'Agency', this.value)">${createSelectOptions(agencies, person.Agency)}</select></td>
            <td><select class="filter-input" onchange="updateIndividual(${index}, 'Unit', this.value)">${createSelectOptions(units, person.Unit)}</select></td>
            <td><select class="filter-input" onchange="updateIndividual(${index}, 'Location', this.value)">${createSelectOptions(locations, person.Location)}</select></td>
            <td><select class="filter-input" onchange="updateIndividual(${index}, 'Title', this.value)">${createSelectOptions(titles, person.Title)}</select></td>
            <td><select class="filter-input" onchange="updateIndividual(${index}, 'ICSRole', this.value)">${createSelectOptions(icsRoles, person.ICSRole)}</select></td>
            <td><input class="filter-input" value="${person.AssignedTo || ''}" onchange="updateIndividual(${index}, 'AssignedTo', this.value)"></td>
            <td><select class="filter-input" onchange="updateIndividual(${index}, 'Lead', this.value)"><option value="Yes" ${person.Lead === 'Yes' ? 'selected' : ''}>Yes</option><option value="No" ${person.Lead === 'No' ? 'selected' : ''}>No</option></select></td>
            <td><input class="filter-input" value="${person.Remarks || ''}" onchange="updateIndividual(${index}, 'Remarks', this.value)"></td>
            <td><button class="delete-btn" onclick="removeIndividual(${index})">Delete</button></td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function updateIndividual(index, field, value) {
      if (individualData[index]) {
        individualData[index][field] = value;
      }
    }

    function removeIndividual(index) {
      if (confirm('Are you sure you want to delete this individual?')) {
        individualData.splice(index, 1);
        loadIndividualsTable();
      }
    }

    function addIndividualRow() {
      individualData.push({
        First: '', Last: '', Phone: '', Phone2: '', Email: '',
        Agency: 'USFS', Unit: 'COFMS', Location: 'Cascade Division',
        Title: '', ICSRole: 'FFT1', AssignedTo: '', Lead: 'No', Remarks: ''
      });
      loadIndividualsTable();
    }

    function saveIndividuals() {
      renderPage();
      alert('Individuals updated! Use CSV controls to download changes.');
      closeModal('individualsModal');
    }

    function addResourceRow() {
      resourceData.push({
        ResourceType: 'Duty Officer', ResourceName: '', Leader: '',
        Assigned: 1, Status: 'In Service', Location: 'Cascade Division', Remarks: ''
      });
      loadResourcesTable();
    }

    function addAviationRow() {
      aviationData["Rotor Wing"].push({
        Type: 'HEL T1', Resource: '', Status: 'Available', Location: 'Redmond', OnOff: '0800-2000'
      });
      loadAviationTable();
    }

    function saveResources() {
      renderPage();
      alert('Resources updated! Use CSV controls to download changes.');
      closeModal('resourcesModal');
    }

    function saveAviation() {
      renderPage();
      alert('Aviation updated! Use CSV controls to download changes.');
      closeModal('aviationModal');
    }

    // UI Creation
    function createDivisionSection(division) {
      const div = document.createElement('div');
      div.className = 'division-section';
      div.dataset.division = division.name;

      const header = document.createElement('div');
      header.className = 'division-header';
      header.innerHTML = `
        <h2>${division.name}</h2>
        <div class="division-meta">
          <strong>Last Modified:</strong> ${division.lastModified}
          <br><button class="btn update-btn" onclick="toggleDivisionEdit(this.closest('.division-section'), arguments[0])" data-division='${JSON.stringify(division)}'>Edit Section</button>
        </div>
      `;
      
      const dutyInfo = document.createElement('div');
      dutyInfo.className = 'duty-info';
      dutyInfo.innerHTML = `
        <strong>Duty Officer:</strong> ${division.dutyOfficer || 'None Assigned'} | 
        <strong>Agency Admin(s):</strong> ${division.agencyAdmins.length > 0 ? division.agencyAdmins.join(', ') : 'None Assigned'}
      `;

      const table = document.createElement('table');
      table.className = 'division-table';
      
      const filteredResources = division.resources.filter(shouldShowResource);
      
      table.innerHTML = `
        <thead>
          <tr>
            <th>Resource Type</th><th>Resource Name</th><th>Leader</th><th># Assigned</th><th>Status</th><th>Location</th><th>Remarks</th>
          </tr>
        </thead>
        <tbody>
          ${filteredResources.map(res => `
            <tr class="${getStatusClass(res.status)}">
              <td>${res.type}</td>
              <td>${res.name}</td>
              <td>${res.leader}</td>
              <td>${res.assigned}</td>
              <td>${res.status}</td>
              <td>${res.location}</td>
              <td>${res.remarks}</td>
            </tr>
          `).join('')}
        </tbody>
      `;

      div.appendChild(header);
      div.appendChild(dutyInfo);
      div.appendChild(table);
      return div;
    }

    function createAviationSection() {
      const container = document.createElement('div');
      container.className = 'aviation-section';

      const aviationResources = [];
      Object.entries(aviationData).forEach(([type, resources]) => {
        resources.forEach(resource => {
          aviationResources.push({
            type: type,
            resource: resource.Resource,
            status: resource.Status,
            location: resource.Location,
            onoff: resource.OnOff
          });
        });
      });

      const rotorWing = aviationResources.filter(r => r.type === 'Rotor Wing');
      const fixedWing = aviationResources.filter(r => r.type === 'Fixed Wing');

      container.innerHTML = '<h2>Aviation Resources</h2>';
      container.appendChild(createAviationTable('Rotor Wing', rotorWing));
      container.appendChild(createAviationTable('Fixed Wing', fixedWing));
      return container;
    }

    function createAviationTable(title, data) {
      const wrapper = document.createElement('div');
      wrapper.className = 'aviation-table-section';

      const table = document.createElement('table');
      table.className = 'aviation-table';
      table.innerHTML = `
        <thead><tr><th colspan="5">${title}</th></tr>
        <tr><th>Type</th><th>Resource</th><th>Status</th><th>Location</th><th>On/Off</th></tr></thead>
        <tbody>
          ${data.map(row => `
            <tr>
              <td>${row.type}</td>
              <td>${row.resource}</td>
              <td>${row.status}</td>
              <td>${row.location}</td>
              <td>${row.onoff}</td>
            </tr>
          `).join('')}
        </tbody>
      `;

      wrapper.appendChild(table);
      return wrapper;
    }

    function renderPage() {
      // Update COFMS Duty Officer
      document.getElementById('cofms-duty-officer').innerHTML = getCOFMSDutyOfficer();
      
      // Render divisions
      const staffingData = getStaffingData();
      const staffingEl = document.getElementById('staffing-container');
      staffingEl.innerHTML = '';
      
      staffingData.forEach(div => {
        const divElement = createDivisionSection(div);
        // Fix the edit button click handler
        const editBtn = divElement.querySelector('.btn.update-btn');
        editBtn.onclick = () => toggleDivisionEdit(divElement, div);
        staffingEl.appendChild(divElement);
      });

      // Render aviation
      const aviationEl = document.getElementById('aviation-container');
      aviationEl.innerHTML = '';
      aviationEl.appendChild(createAviationSection());
    }

    // Initialize
    renderPage();

    // Close modal when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }
  </script>
</body>
</html>