<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Central Oregon Staffing</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f8f8;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .main-content {
      display: flex;
      gap: 20px;
    }
    .division-column {
      flex: 3;
    }
    .aviation-column {
      flex: 1;
    }
    .division-section, .aviation-table-section {
      margin-bottom: 30px;
      background: #fff;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .division-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    .division-meta {
      font-size: 0.8em;
      text-align: right;
      line-height: 1.4;
      color: #666;
    }
    .duty-info {
      margin: 10px 0;
      padding: 8px;
      background: #f9f9f9;
      border-left: 4px solid #2196f3;
      font-size: 0.9em;
    }
    .division-table, .aviation-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .division-table th, .division-table td,
    .aviation-table th, .aviation-table td {
      border: 1px solid #ddd;
      padding: 8px 10px;
      text-align: left;
    }
    .division-table th, .aviation-table th {
      background-color: #f5f5f5;
      font-weight: bold;
    }
    .btn.update-btn {
      padding: 4px 8px;
      background: #ddd;
      color: #666;
      border: none;
      cursor: pointer;
      border-radius: 3px;
      font-size: 11px;
      margin-top: 5px;
    }
    .btn.update-btn:hover {
      background: #ccc;
    }
    .edit-input, .edit-select {
      width: 100%;
      box-sizing: border-box;
      padding: 4px;
      border: 1px solid #ccc;
    }
    .resource-search-container {
      position: relative;
      width: 100%;
    }
    .resource-search-input {
      width: 100%;
      padding: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    .resource-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    .resource-option {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .resource-option:hover {
      background: #f0f0f0;
    }
    .resource-option.highlighted {
      background: #e3f2fd;
    }
    .add-btn, .save-btn {
      background: #2e7d32;
      color: #fff;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      margin: 6px 4px 6px 0;
      border-radius: 3px;
    }
    .add-btn:hover, .save-btn:hover {
      background: #1b5e20;
    }
    .delete-btn {
      background: #c62828;
      color: #fff;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 3px;
    }
    .delete-btn:hover {
      background: #8e0000;
    }
    .status-late {
      background-color: #ffebee !important;
      color: #c62828;
      font-weight: bold;
    }
    .status-out {
      color: #666;
      font-style: italic;
    }
    .status-committed {
      background-color: #fff3e0 !important;
      color: #ef6c00;
    }
    .status-delayed {
      background-color: #fff8e1 !important;
      color: #f57c00;
    }
    .csv-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: none;
    }
    .csv-controls.show {
      display: block;
    }
    .csv-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 4px;
    }
    .csv-btn {
      padding: 4px 8px;
      font-size: 11px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      white-space: nowrap;
    }
    .csv-btn.download {
      background: #4caf50;
      color: white;
    }
    .csv-btn.upload {
      background: #2196f3;
      color: white;
    }
    .csv-btn:hover {
      opacity: 0.8;
    }
    .filter-controls {
      margin: 10px 0;
    }
    .filter-controls label {
      margin-right: 15px;
    }
    .cofms-header {
      background: #e3f2fd;
      border: 2px solid #1976d2;
      text-align: center;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 5px;
    }
    .cofms-header h2 {
      margin: 0 0 10px 0;
      color: #1976d2;
    }
    .data-management-btn {
      background: #ff9800;
      color: white;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 3px;
      margin: 6px 4px;
    }
    .data-management-btn:hover {
      background: #f57c00;
    }
  </style>
</head>
<body>
  <h1>Central Oregon Staffing</h1>
  
  <div class="csv-controls" id="csvControls">
    <div class="csv-buttons">
      <button class="csv-btn download" onclick="downloadCSV('individuals')">↓ Individuals</button>
      <button class="csv-btn download" onclick="downloadCSV('resources')">↓ Resources</button>
      <button class="csv-btn download" onclick="downloadCSV('aviation')">↓ Aviation</button>
      <input type="file" id="uploadIndividuals" style="display:none" accept=".csv" onchange="uploadCSV(event, 'individuals')">
      <button class="csv-btn upload" onclick="document.getElementById('uploadIndividuals').click()">↑ Individuals</button>
      <input type="file" id="uploadResources" style="display:none" accept=".csv" onchange="uploadCSV(event, 'resources')">
      <button class="csv-btn upload" onclick="document.getElementById('uploadResources').click()">↑ Resources</button>
      <input type="file" id="uploadAviation" style="display:none" accept=".csv" onchange="uploadCSV(event, 'aviation')">
      <button class="csv-btn upload" onclick="document.getElementById('uploadAviation').click()">↑ Aviation</button>
    </div>
  </div>
  
  <div class="cofms-header">
    <h2>COFMS Duty Officer</h2>
    <div id="cofms-duty-officer">Loading data...</div>
  </div>

  <div class="filter-controls">
    <label><input type="checkbox" id="filterOutOfService" checked> Hide Out of Service</label>
    <label><input type="checkbox" id="filterOffForest"> Hide Off Forest</label>
    <button class="update-btn" onclick="renderPage()">Apply Filters</button>
  </div>

  <div class="main-content">
    <div id="staffing-container" class="division-column"></div>
    <div id="aviation-container" class="aviation-column"></div>
  </div>

  <script>
    // Global edit state
    let isEditMode = false;

    // Data storage - initialize with sample data from your JSON files
    let individualData = [
      {
        "First": "Jane",
        "Last": "Smith",
        "Phone": "541-555-1234",
        "Phone2": "541-555-5678",
        "Email": "jane.smith@example.com",
        "Agency": "USFS",
        "Unit": "COFMS",
        "Location": "Cascade Division",
        "Title": "USFS-IC",
        "ICSRole": "AA",
        "AssignedTo": "Crew 1",
        "Lead": "Yes",
        "Remarks": ""
      }
    ];

    let resourceData = [
      {
        "type": "FMO",
        "name": "OR-DEF-DV4",
        "leader": "Gregg",
        "assigned": 0,
        "status": "Out of Service",
        "location": "Cascade",
        "remarks": "ICT3"
      },
      {
        "type": "Duty Officer",
        "name": "OR-DEF-BC41",
        "leader": "Smith-Howard",
        "assigned": 0,
        "status": "In Service",
        "location": "Cascade",
        "remarks": "ICT4"
      },
      {
        "type": "BC",
        "name": "OR-DEF-BC42",
        "leader": "Gottfried",
        "assigned": 0,
        "status": "Out of Service",
        "location": "Cascade",
        "remarks": "ICT3"
      }
      // Add more of your resource data here...
    ];

    let aviationData = { 
      "Rotor Wing": [
        {
          "Type": "HEL T1",
          "Resource": "N1234H",
          "Status": "Available",
          "Location": "Redmond",
          "OnOff": "0800-2000"
        }
      ],
      "Fixed Wing": [
        {
          "Type": "SEAT",
          "Resource": "N5678F",
          "Status": "Unavailable",
          "Location": "Prineville",
          "OnOff": "0800-2000"
        }
      ]
    };

    // Configuration arrays
    const divisions = [
      "Cascade Division", "Crescent Division", "Newberry East", "Newberry West", 
      "Rivers Division", "Prairie Division", "ODF Prineville", "ODF Sisters", "ODF Fossil"
    ];

    const agencies = ["USFS", "BLM", "ODF"];
    
    const units = [
      "Prineville FO", "Deschutes FO", "Central Oregon", "DEF-Bend", "DEF-Sisters", 
      "DEF-Crescent", "OCF-Prineville", "COFMS"
    ];

    const locations = [
      "Cascade", "Crescent", "Newberry East", "Newberry West", "Rivers", "Prairie", 
      "ODF Sisters", "ODF Prineville", "ODF Fossil", "ODF John Day", "BIAK", "Walker Range"
    ];

    const titles = [
      "BLM-Prineville District Manager", "BLM-Deschutes Field Manager", 
      "BLM-Central Oregon Manager", "USFS-IC", "FMO", "BC", "Operations"
    ];

    const icsRoles = ["FFT1", "FFT2", "TFLD", "DIVS", "AA", "AR"];

    const resourceTypes = [
      "Duty Officer", "Overhead (FMO)", "Overhead (FT)", "Overhead (BC)", "Prevention", 
      "Lookout", "ENG T3", "ENG T5", "ENG T6", "Overhead (FOS)", "CRWT2 IA", "CRWT2", 
      "IHC", "WFMT1", "WFMT2", "HEL T1", "HEL T2", "HEL T3", "DOZ T1", "DOZ T2", 
      "DOZ T3", "WTS T1", "WTS T2", "WTS T3", "IA MOD", "Severity", "Support"
    ];

    const statuses = ["In Service", "Delayed Response", "Out of Service", "Off Forest", "Late Resource", "Committed"];

    // Helper functions
    function createSelectOptions(array, selected = '', allowCustom = false) {
      let options = array.map(item => 
        `<option value="${item}" ${item === selected ? 'selected' : ''}>${item}</option>`
      ).join('');
      
      if (allowCustom && selected && !array.includes(selected)) {
        options += `<option value="${selected}" selected>${selected}</option>`;
      }
      
      return options;
    }

    function getStatusClass(status) {
      switch(status) {
        case 'Late Resource': return 'status-late';
        case 'Out of Service': return 'status-out';
        case 'Committed': return 'status-committed';
        case 'Delayed Response': return 'status-delayed';
        default: return '';
      }
    }

    function sortResourcesByStatus(resources) {
      const statusOrder = ['Late Resource', 'In Service', 'Delayed Response', 'Committed', 'Off Forest', 'Out of Service'];
      return resources.sort((a, b) => {
        const aIndex = statusOrder.indexOf(a.status) === -1 ? 999 : statusOrder.indexOf(a.status);
        const bIndex = statusOrder.indexOf(b.status) === -1 ? 999 : statusOrder.indexOf(b.status);
        return aIndex - bIndex;
      });
    }

    function shouldShowResource(resource) {
      const hideOutOfService = document.getElementById('filterOutOfService').checked;
      const hideOffForest = document.getElementById('filterOffForest').checked;
      
      if (hideOutOfService && resource.status === 'Out of Service') return false;
      if (hideOffForest && resource.status === 'Off Forest') return false;
      return true;
    }

    // Resource search and auto-populate functions
    function createResourceSearchField(selectedResource = '') {
      const searchId = 'resource-search-' + Math.random().toString(36).substr(2, 9);
      const dropdownId = 'resource-dropdown-' + Math.random().toString(36).substr(2, 9);
      
      return `
        <div class="resource-search-container">
          <input 
            type="text" 
            class="resource-search-input" 
            id="${searchId}"
            value="${selectedResource}"
            placeholder="Type to search resources..."
            onkeyup="filterResources('${searchId}', '${dropdownId}')"
            onfocus="showResourceDropdown('${dropdownId}')"
            onblur="hideResourceDropdown('${dropdownId}')"
          >
          <div class="resource-dropdown" id="${dropdownId}"></div>
        </div>
      `;
    }

    function filterResources(inputId, dropdownId) {
      const input = document.getElementById(inputId);
      const dropdown = document.getElementById(dropdownId);
      const searchTerm = input.value.toLowerCase();
      
      // Filter resources based on search term
      const filteredResources = resourceData.filter(resource => 
        resource.name.toLowerCase().includes(searchTerm) ||
        resource.type.toLowerCase().includes(searchTerm) ||
        resource.leader.toLowerCase().includes(searchTerm)
      );
      
      // Build dropdown options
      let optionsHTML = '';
      filteredResources.forEach(resource => {
        optionsHTML += `
          <div class="resource-option" 
               onmousedown="selectResource('${inputId}', '${resource.name}', ${JSON.stringify(resource).replace(/"/g, '&quot;')})">
            <strong>${resource.name}</strong> - ${resource.type} (${resource.leader})
          </div>
        `;
      });
      
      dropdown.innerHTML = optionsHTML;
      dropdown.style.display = optionsHTML ? 'block' : 'none';
    }

    function showResourceDropdown(dropdownId) {
      const dropdown = document.getElementById(dropdownId);
      const inputId = dropdownId.replace('resource-dropdown-', 'resource-search-');
      filterResources(inputId, dropdownId);
    }

    function hideResourceDropdown(dropdownId) {
      setTimeout(() => {
        const dropdown = document.getElementById(dropdownId);
        dropdown.style.display = 'none';
      }, 200); // Small delay to allow click events to fire
    }

    function selectResource(inputId, resourceName, resourceData) {
      const input = document.getElementById(inputId);
      const row = input.closest('tr');
      
      // Set the input value
      input.value = resourceName;
      
      // Auto-populate other fields
      populateResourceFields(row, resourceData);
      
      // Hide dropdown
      const dropdownId = inputId.replace('resource-search-', 'resource-dropdown-');
      document.getElementById(dropdownId).style.display = 'none';
    }

    function populateResourceFields(row, resource) {
      const cells = row.querySelectorAll('td');
      
      // Type field (first select)
      const typeSelect = cells[0]?.querySelector('select');
      if (typeSelect && resource.type) {
        typeSelect.value = resource.type;
      }
      
      // Leader field (third cell)
      const leaderField = cells[2]?.querySelector('input, select');
      if (leaderField && resource.leader) {
        leaderField.value = resource.leader;
      }
      
      // Assigned field (fourth cell)
      const assignedField = cells[3]?.querySelector('input');
      if (assignedField && resource.assigned !== undefined) {
        assignedField.value = resource.assigned;
      }
      
      // Status field (fifth cell)
      const statusSelect = cells[4]?.querySelector('select');
      if (statusSelect && resource.status) {
        statusSelect.value = resource.status;
      }
      
      // Location field (sixth cell)
      const locationField = cells[5]?.querySelector('input, select');
      if (locationField && resource.location) {
        locationField.value = resource.location;
      }
      
      // Remarks field (seventh cell)
      const remarksField = cells[6]?.querySelector('input');
      if (remarksField && resource.remarks) {
        remarksField.value = resource.remarks;
      }
    }

    // Data transformation
    function getStaffingData() {
      const divisionMap = new Map();
      
      // Initialize all divisions
      divisions.forEach(divName => {
        divisionMap.set(divName, {
          name: divName,
          dutyOfficer: '',
          agencyAdmins: [],
          lastModified: new Date().toLocaleString(),
          resources: []
        });
      });
      
      // Add individuals to divisions
      individualData.forEach(person => {
        const location = person.Location || 'Unassigned';
        const divName = divisions.find(d => d.includes(location)) || location;
        
        if (!divisionMap.has(divName)) {
          divisionMap.set(divName, {
            name: divName,
            dutyOfficer: '',
            agencyAdmins: [],
            lastModified: new Date().toLocaleString(),
            resources: []
          });
        }
        
        const division = divisionMap.get(divName);
        if (person.ICSRole === 'AA' || person.ICSRole === 'AR') {
          division.agencyAdmins.push(`${person.First} ${person.Last} (${person.Phone}${person.Phone2 ? ' / ' + person.Phone2 : ''}, ${person.Email})`);
        }
      });

      // Add resources to divisions and find duty officers
      resourceData.forEach(resource => {
        const location = resource.location || 'Unassigned';
        const divName = divisions.find(d => d.includes(location)) || location;
        
        if (divisionMap.has(divName)) {
          const division = divisionMap.get(divName);
          division.resources.push({
            type: resource.type,
            name: resource.name,
            leader: resource.leader,
            assigned: resource.assigned,
            status: resource.status,
            location: resource.location,
            remarks: resource.remarks
          });
          
          if (resource.type === 'Duty Officer') {
            division.dutyOfficer = resource.leader;
          }
        }
      });

      // Sort resources by status for each division
      divisionMap.forEach(division => {
        division.resources = sortResourcesByStatus(division.resources);
      });

      return Array.from(divisionMap.values());
    }

    function getCOFMSDutyOfficer() {
      const cofmsResource = resourceData.find(r => 
        r.type === 'Duty Officer' && r.name && r.name.includes('COFMS')
      );
      
      if (cofmsResource) {
        const individual = individualData.find(i => 
          `${i.First} ${i.Last}` === cofmsResource.leader
        );
        if (individual) {
          return `${individual.First} ${individual.Last}<br>Phone: ${individual.Phone}${individual.Phone2 ? ' / ' + individual.Phone2 : ''}<br>Email: ${individual.Email}`;
        }
        return cofmsResource.leader;
      }
      return 'None Assigned';
    }

    // CSV handling functions
    function downloadCSV(type) {
      let rows = [];
      let filename = '';
      
      switch(type) {
        case 'individuals':
          rows.push(['First', 'Last', 'Phone', 'Phone2', 'Email', 'Agency', 'Unit', 'Location', 'Title', 'ICSRole', 'AssignedTo', 'Lead', 'Remarks']);
          individualData.forEach(person => {
            rows.push([
              person.First || '', person.Last || '', person.Phone || '', person.Phone2 || '',
              person.Email || '', person.Agency || '', person.Unit || '', person.Location || '',
              person.Title || '', person.ICSRole || '', person.AssignedTo || '', person.Lead || '', person.Remarks || ''
            ]);
          });
          filename = 'individuals.csv';
          break;
          
        case 'resources':
          rows.push(['type', 'name', 'leader', 'assigned', 'status', 'location', 'remarks']);
          resourceData.forEach(resource => {
            rows.push([
              resource.type || '', resource.name || '', resource.leader || '',
              resource.assigned || '', resource.status || '', resource.location || '', resource.remarks || ''
            ]);
          });
          filename = 'resources.csv';
          break;
          
        case 'aviation':
          rows.push(['Type', 'Resource', 'Status', 'Location', 'OnOff']);
          Object.entries(aviationData).forEach(([type, resources]) => {
            resources.forEach(resource => {
              rows.push([type, resource.Resource || '', resource.Status || '', resource.Location || '', resource.OnOff || '']);
            });
          });
          filename = 'aviation.csv';
          break;
      }
      
      const csv = rows.map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
      ).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function uploadCSV(event, type) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.trim().split('\n');
          const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
          
          const newData = [];
          for (let i = 1; i < lines.length; i++) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            // Parse CSV properly handling quoted values
            for (let j = 0; j < lines[i].length; j++) {
              const char = lines[i][j];
              if (char === '"') {
                inQuotes = !inQuotes;
              } else if (char === ',' && !inQuotes) {
                values.push(current.trim());
                current = '';
              } else {
                current += char;
              }
            }
            values.push(current.trim()); // Add the last value
            
            const row = {};
            headers.forEach((header, index) => {
              row[header] = values[index] ? values[index].replace(/^"|"$/g, '') : '';
            });
            newData.push(row);
          }
          
          switch(type) {
            case 'individuals':
              individualData = newData;
              break;
            case 'resources':
              resourceData = newData;
              break;
            case 'aviation':
              // Convert flat CSV back to nested structure
              const newAviationData = { "Rotor Wing": [], "Fixed Wing": [] };
              newData.forEach(row => {
                const aviationItem = {
                  Resource: row.Resource || '',
                  Status: row.Status || '',
                  Location: row.Location || '',
                  OnOff: row.OnOff || ''
                };
                
                if (row.Type === 'Rotor Wing') {
                  aviationItem.Type = 'HEL T1';
                  newAviationData["Rotor Wing"].push(aviationItem);
                } else if (row.Type === 'Fixed Wing') {
                  aviationItem.Type = 'SEAT';
                  newAviationData["Fixed Wing"].push(aviationItem);
                }
              });
              aviationData = newAviationData;
              break;
          }
          
          renderPage();
          alert(`${type} CSV loaded successfully!`);
        } catch (error) {
          alert(`Error loading ${type} CSV: ${error.message}`);
        }
      };
      reader.readAsText(file);
    }

    // Edit functions
    function toggleEditMode() {
      isEditMode = !isEditMode;
      const csvControls = document.getElementById('csvControls');
      if (isEditMode) {
        csvControls.classList.add('show');
      } else {
        csvControls.classList.remove('show');
      }
    }

    function createEditableRow(resource) {
      // Get all individuals for leader dropdown
      const leaders = individualData.map(i => `${i.First} ${i.Last}`);
      
      return `
        <tr>
          <td><select class="edit-select">${createSelectOptions(resourceTypes, resource.type, true)}</select></td>
          <td>${createResourceSearchField(resource.name)}</td>
          <td><input class="edit-input" value="${resource.leader}" placeholder="Leader name"></td>
          <td><input class="edit-input" type="number" value="${resource.assigned}" /></td>
          <td><select class="edit-select">${createSelectOptions(statuses, resource.status)}</select></td>
          <td><input class="edit-input" list="locationsList" value="${resource.location}">
              <datalist id="locationsList">${locations.map(loc => `<option value="${loc}">`).join('')}</datalist></td>
          <td><input class="edit-input" value="${resource.remarks}" /></td>
          <td><button class="delete-btn" onclick="this.closest('tr').remove()">✖</button></td>
        </tr>
      `;
    }

    function toggleDivisionEdit(div, divisionData) {
      toggleEditMode();
      
      const table = div.querySelector('table');
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = divisionData.resources.map(res => createEditableRow(res)).join('');

      const addBtn = document.createElement('button');
      addBtn.className = 'add-btn';
      addBtn.textContent = '+ Add Resource';
      addBtn.onclick = () => {
        const tr = document.createElement('tr');
        tr.innerHTML = createEditableRow({ type: '', name: '', leader: '', assigned: 1, status: 'In Service', location: divisionData.name, remarks: '' });
        tbody.appendChild(tr);
      };

      const dataManageBtn = document.createElement('button');
      dataManageBtn.className = 'data-management-btn';
      dataManageBtn.textContent = 'Manage Data';
      dataManageBtn.onclick = () => {
        alert('Data management functionality can be expanded here');
      };

      // Clear previous buttons
      const prevButtons = div.querySelectorAll('.add-btn, .data-management-btn, .save-btn');
      prevButtons.forEach(btn => btn.remove());
      
      table.insertAdjacentElement('beforebegin', addBtn);
      table.insertAdjacentElement('beforebegin', dataManageBtn);
      
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save-btn';
      saveBtn.textContent = 'Save Section';
      saveBtn.onclick = () => {
        const updatedRows = [];
        tbody.querySelectorAll('tr').forEach(row => {
          const typeSelect = row.querySelector('select');
          const resourceInput = row.querySelector('.resource-search-input');
          const leaderInput = row.querySelectorAll('input')[1]; // Second input
          const assignedInput = row.querySelector('input[type="number"]');
          const statusSelect = row.querySelectorAll('select')[1]; // Second select
          const locationInput = row.querySelectorAll('input')[3]; // Fourth input
          const remarksInput = row.querySelectorAll('input')[4]; // Fifth input
          
          if (resourceInput && resourceInput.value.trim()) {
            updatedRows.push({
              type: typeSelect ? typeSelect.value : '',
              name: resourceInput.value.trim(),
              leader: leaderInput ? leaderInput.value : '',
              assigned: assignedInput ? parseInt(assignedInput.value) || 0 : 0,
              status: statusSelect ? statusSelect.value : 'In Service',
              location: locationInput ? locationInput.value : divisionData.name,
              remarks: remarksInput ? remarksInput.value : ''
            });
          }
        });

        // Update resourceData - remove old resources for this location and add new ones
        resourceData = resourceData.filter(r => r.location !== divisionData.name);
        updatedRows.forEach(row => {
          resourceData.push(row);
        });

        renderPage();
        alert('Division saved! Use "↓ Resources" to download updated CSV.');
      };

      div.appendChild(saveBtn);
    }

    function renderPage() {
      const staffingContainer = document.getElementById('staffing-container');
      const aviationContainer = document.getElementById('aviation-container');
      const dutyOfficerDiv = document.getElementById('cofms-duty-officer');

      // Set COFMS duty officer block
      dutyOfficerDiv.innerHTML = getCOFMSDutyOfficer();

      // Clear and rebuild staffing container
      staffingContainer.innerHTML = '';
      const staffingData = getStaffingData();

      staffingData.forEach(division => {
        const section = document.createElement('div');
        section.className = 'division-section';

        const resourcesHTML = division.resources
          .filter(shouldShowResource)
          .map(r => `
            <tr class="${getStatusClass(r.status)}" title="${r.remarks || ''}">
              <td>${r.type}</td>
              <td>${r.name}</td>
              <td>${r.leader}</td>
              <td>${r.assigned}</td>
              <td>${r.status}</td>
              <td>${r.location}</td>
              <td>${r.remarks}</td>
            </tr>
          `).join('');

        section.innerHTML = `
          <div class="division-header">
            <h3>${division.name}</h3>
            <div class="division-meta">
              Last Modified: ${division.lastModified}<br>
              ${division.agencyAdmins.length ? `Agency Admin(s):<br>${division.agencyAdmins.join('<br>')}` : ''}
            </div>
          </div>
          ${division.dutyOfficer ? `<div class="duty-info"><strong>Duty Officer:</strong> ${division.dutyOfficer}</div>` : ''}
          <table class="division-table">
            <thead>
              <tr><th>Type</th><th>Resource</th><th>Leader</th><th>Assigned</th><th>Status</th><th>Location</th><th>Remarks</th></tr>
            </thead>
            <tbody>
              ${resourcesHTML || `<tr><td colspan="7"><em>No resources shown with current filters.</em></td></tr>`}
            </tbody>
          </table>
          <button class="update-btn" onclick="toggleDivisionEdit(this.parentElement, ${JSON.stringify(division).replace(/"/g, '&quot;')})">✎ Edit</button>
        `;

        staffingContainer.appendChild(section);
      });

      // Rebuild aviation section
      aviationContainer.innerHTML = '';
      Object.entries(aviationData).forEach(([wingType, resources]) => {
        const section = document.createElement('div');
        section.className = 'aviation-table-section';
        section.innerHTML = `
          <h3>${wingType}</h3>
          <table class="aviation-table">
            <thead>
              <tr><th>Type</th><th>Resource</th><th>Status</th><th>Location</th><th>On/Off</th></tr>
            </thead>
            <tbody>
              ${resources.map(r => `
                <tr class="${getStatusClass(r.Status)}" title="${r.Type || ''}">
                  <td>${r.Type}</td>
                  <td>${r.Resource}</td>
                  <td>${r.Status}</td>
                  <td>${r.Location}</td>
                  <td>${r.OnOff}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        aviationContainer.appendChild(section);
      });
    }

    // Load data from JSON files if available
    async function loadJSONFiles() {
      console.log('Loading JSON files...');
      
      try {
        // Try to load individuals.json
        try {
          const individualsResponse = await fetch('data/individuals.json');
          if (individualsResponse.ok) {
            individualData = await individualsResponse.json();
            console.log('✓ individuals.json loaded');
          }
        } catch (error) {
          console.log('individuals.json not found, using sample data');
        }

        // Try to load resources.json
        try {
          const resourcesResponse = await fetch('data/resources.json');
          if (resourcesResponse.ok) {
            const loadedResources = await resourcesResponse.json();
            // Convert to expected format if needed
            resourceData = loadedResources.map(resource => ({
              type: resource.type || resource.ResourceType || '',
              name: resource.name || resource.ResourceName || '',
              leader: resource.leader || resource.Leader || '',
              assigned: resource.assigned || resource.Assigned || 0,
              status: resource.status || resource.Status || 'In Service',
              location: resource.location || resource.Location || '',
              remarks: resource.remarks || resource.Remarks || ''
            }));
            console.log('✓ resources.json loaded and converted');
          }
        } catch (error) {
          console.log('resources.json not found, using sample data');
        }

        // Try to load aviation.json
        try {
          const aviationResponse = await fetch('data/aviation.json');
          if (aviationResponse.ok) {
            aviationData = await aviationResponse.json();
            console.log('✓ aviation.json loaded');
          }
        } catch (error) {
          console.log('aviation.json not found, using sample data');
        }

      } catch (error) {
        console.error('Error loading JSON files:', error);
      }

      // Always render the page
      renderPage();
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      loadJSONFiles();
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.resource-search-container')) {
        document.querySelectorAll('.resource-dropdown').forEach(dropdown => {
          dropdown.style.display = 'none';
        });
      }
    });

  </script>
</body>
</html>