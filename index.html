<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Central Oregon Staffing</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f8f8;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .main-controls {
      text-align: center;
      margin-bottom: 20px;
    }
    .main-content {
      display: flex;
      gap: 20px;
    }
    .division-column {
      flex: 3;
    }
    .aviation-column {
      flex: 1;
    }
    .division-section, .aviation-table-section {
      margin-bottom: 30px;
      background: #fff;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .division-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    .division-meta {
      font-size: 0.8em;
      text-align: right;
      line-height: 1.4;
      color: #666;
    }
    .duty-info {
      margin: 10px 0;
      padding: 8px;
      background: #f9f9f9;
      border-left: 4px solid #2196f3;
      font-size: 0.9em;
    }
    .division-table, .aviation-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .division-table th, .division-table td,
    .aviation-table th, .aviation-table td {
      border: 1px solid #ddd;
      padding: 8px 10px;
      text-align: left;
    }
    .division-table th, .aviation-table th {
      background-color: #f5f5f5;
      font-weight: bold;
    }
    .edit-input, .edit-select {
      width: 100%;
      box-sizing: border-box;
      padding: 4px;
      border: 1px solid #ccc;
    }
    .resource-search-container {
      position: relative;
      width: 100%;
    }
    .resource-search-input {
      width: 100%;
      padding: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    .resource-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    .resource-option {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .resource-option:hover {
      background: #f0f0f0;
    }
    .primary-btn {
      background: #1976d2;
      color: #fff;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      margin: 5px;
      border-radius: 5px;
      font-size: 14px;
    }
    .primary-btn:hover {
      background: #1565c0;
    }
    .secondary-btn {
      background: #ff9800;
      color: #fff;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      margin: 5px;
      border-radius: 3px;
      font-size: 12px;
    }
    .secondary-btn:hover {
      background: #f57c00;
    }
    .save-btn {
      background: #2e7d32;
      color: #fff;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      margin: 5px;
      border-radius: 3px;
    }
    .save-btn:hover {
      background: #1b5e20;
    }
    .cancel-btn {
      background: #757575;
      color: #fff;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      margin: 5px;
      border-radius: 3px;
    }
    .cancel-btn:hover {
      background: #616161;
    }
    .delete-btn {
      background: #c62828;
      color: #fff;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 3px;
      font-size: 11px;
    }
    .delete-btn:hover {
      background: #8e0000;
    }
    .add-btn {
      background: #2e7d32;
      color: #fff;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      margin: 5px 0;
      border-radius: 3px;
    }
    .add-btn:hover {
      background: #1b5e20;
    }
    .status-late {
      background-color: #ffebee !important;
      color: #c62828;
      font-weight: bold;
    }
    .status-out {
      color: #666;
      font-style: italic;
    }
    .status-committed {
      background-color: #fff3e0 !important;
      color: #ef6c00;
    }
    .status-delayed {
      background-color: #fff8e1 !important;
      color: #f57c00;
    }
    .filter-controls {
      margin: 10px 0;
      text-align: center;
    }
    .filter-controls label {
      margin-right: 15px;
    }
    .cofms-header {
      background: #e3f2fd;
      border: 2px solid #1976d2;
      text-align: center;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 5px;
    }
    .cofms-header h2 {
      margin: 0 0 10px 0;
      color: #1976d2;
    }
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 95%;
      max-width: 1400px;
      border-radius: 5px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .data-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .data-tab {
      padding: 10px 20px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      cursor: pointer;
      border-radius: 5px 5px 0 0;
    }
    .data-tab.active {
      background: #1976d2;
      color: white;
    }
    .data-tab:hover {
      background: #e0e0e0;
    }
    .data-tab.active:hover {
      background: #1565c0;
    }
    .filter-section {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .filter-input {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 12px;
    }
    .data-table-container {
      max-height: 500px;
      overflow: auto;
      border: 1px solid #ddd;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th {
      background-color: #f5f5f5;
      padding: 8px;
      border: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .data-table td {
      padding: 6px;
      border: 1px solid #ddd;
    }
    .data-table input, .data-table select {
      width: 100%;
      padding: 4px;
      border: 1px solid #ccc;
      font-size: 11px;
    }
    .edit-mode .division-table td,
    .edit-mode .aviation-table td {
      padding: 4px;
    }
    .edit-mode .division-table input,
    .edit-mode .division-table select,
    .edit-mode .aviation-table input,
    .edit-mode .aviation-table select {
      width: 100%;
      padding: 4px;
      border: 1px solid #ccc;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <h1>Central Oregon Staffing</h1>
  
  <div class="main-controls">
    <button class="primary-btn" id="updateStaffingBtn" onclick="toggleEditMode()">Update Staffing</button>
    <button class="secondary-btn" onclick="openDataEditor()">Update Resources / Aviation</button>
  </div>
  
  <div class="cofms-header">
    <h2>COFMS Duty Officer</h2>
    <div id="cofms-duty-officer">Loading data...</div>
  </div>

  <div class="filter-controls">
    <label><input type="checkbox" id="filterOutOfService" checked> Hide Out of Service</label>
    <label><input type="checkbox" id="filterOffForest"> Hide Off Forest</label>
    <button class="secondary-btn" onclick="renderPage()">Apply Filters</button>
  </div>

  <div class="main-content">
    <div id="staffing-container" class="division-column"></div>
    <div id="aviation-container" class="aviation-column"></div>
  </div>

  <!-- Data Editor Modal -->
  <div id="dataEditorModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Data Editor</h2>
        <span class="close" onclick="closeDataEditor()">&times;</span>
      </div>
      
      <div class="data-tabs">
        <div class="data-tab active" onclick="switchDataTab('resources')">Resources</div>
        <div class="data-tab" onclick="switchDataTab('aviation')">Aviation</div>
        <div class="data-tab" onclick="switchDataTab('personnel')">Personnel</div>
      </div>
      
      <div class="filter-section">
        <h4>Filters</h4>
        <div class="filter-grid" id="filterGrid">
          <!-- Dynamic filter inputs will be added here -->
        </div>
        <button class="secondary-btn" onclick="clearFilters()">Clear Filters</button>
        <button class="add-btn" onclick="addNewRecord()">+ Add New</button>
      </div>
      
      <div class="data-table-container">
        <table class="data-table" id="dataTable">
          <!-- Dynamic table content -->
        </table>
      </div>
      
      <div style="margin-top: 20px; text-align: center;">
        <button class="save-btn" onclick="saveDataChanges()">Save All Changes</button>
        <button class="secondary-btn" onclick="downloadCurrentData()">Download CSV</button>
        <input type="file" id="csvUpload" style="display:none" accept=".csv">
        <button class="secondary-btn" onclick="document.getElementById('csvUpload').click()">Upload CSV</button>
      </div>
    </div>
  </div>

  <script>
    // Global edit state
    let isEditMode = false;
    let currentDataTab = 'resources';
    let filteredData = [];
    let currentFilters = {};

    // Data storage
    let individualData = [
      {
        "First": "Jane",
        "Last": "Smith",
        "Phone": "541-555-1234",
        "Phone2": "541-555-5678",
        "Email": "jane.smith@example.com",
        "Agency": "USFS",
        "Unit": "COFMS",
        "Location": "Cascade Division",
        "Title": "USFS-IC",
        "ICSRole": "AA",
        "AssignedTo": "Crew 1",
        "Lead": "Yes",
        "Remarks": ""
      }
    ];

    let resourceData = [
      {
        "type": "FMO",
        "name": "OR-DEF-DV4",
        "leader": "Gregg",
        "assigned": 0,
        "status": "Out of Service",
        "location": "Cascade",
        "remarks": "ICT3"
      },
      {
        "type": "Duty Officer",
        "name": "OR-DEF-BC41",
        "leader": "Smith-Howard",
        "assigned": 0,
        "status": "In Service",
        "location": "Cascade",
        "remarks": "ICT4"
      },
      {
        "type": "BC",
        "name": "OR-DEF-BC42",
        "leader": "Gottfried",
        "assigned": 0,
        "status": "Out of Service",
        "location": "Cascade",
        "remarks": "ICT3"
      }
    ];

    let aviationData = { 
      "Rotor Wing": [
        {
          "Type": "HEL T1",
          "Resource": "N1234H",
          "Status": "Available",
          "Location": "Redmond",
          "OnOff": "0800-2000"
        }
      ],
      "Fixed Wing": [
        {
          "Type": "SEAT",
          "Resource": "N5678F",
          "Status": "Unavailable",
          "Location": "Prineville",
          "OnOff": "0800-2000"
        }
      ]
    };

    // Configuration arrays
    const divisions = [
      "Cascade Division", "Crescent Division", "Newberry East", "Newberry West", 
      "Rivers Division", "Prairie Division", "ODF Prineville", "ODF Sisters", "ODF Fossil"
    ];

    const agencies = ["USFS", "BLM", "ODF"];
    const units = ["Prineville FO", "Deschutes FO", "Central Oregon", "DEF-Bend", "DEF-Sisters", "DEF-Crescent", "OCF-Prineville", "COFMS"];
    const locations = ["Cascade", "Crescent", "Newberry East", "Newberry West", "Rivers", "Prairie", "ODF Sisters", "ODF Prineville", "ODF Fossil", "ODF John Day", "BIAK", "Walker Range"];
    const titles = ["BLM-Prineville District Manager", "BLM-Deschutes Field Manager", "BLM-Central Oregon Manager", "USFS-IC", "FMO", "BC", "Operations"];
    const icsRoles = ["FFT1", "FFT2", "TFLD", "DIVS", "AA", "AR"];
    const resourceTypes = ["Duty Officer", "Overhead (FMO)", "Overhead (FT)", "Overhead (BC)", "Prevention", "Lookout", "ENG T3", "ENG T5", "ENG T6", "Overhead (FOS)", "CRWT2 IA", "CRWT2", "IHC", "WFMT1", "WFMT2", "HEL T1", "HEL T2", "HEL T3", "DOZ T1", "DOZ T2", "DOZ T3", "WTS T1", "WTS T2", "WTS T3", "IA MOD", "Severity", "Support"];
    const statuses = ["In Service", "Delayed Response", "Out of Service", "Off Forest", "Late Resource", "Committed"];

    // Helper functions
    function createSelectOptions(array, selected = '') {
      return array.map(item => 
        `<option value="${item}" ${item === selected ? 'selected' : ''}>${item}</option>`
      ).join('');
    }

    function getStatusClass(status) {
      switch(status) {
        case 'Late Resource': return 'status-late';
        case 'Out of Service': return 'status-out';
        case 'Committed': return 'status-committed';
        case 'Delayed Response': return 'status-delayed';
        default: return '';
      }
    }

    function shouldShowResource(resource) {
      const hideOutOfService = document.getElementById('filterOutOfService').checked;
      const hideOffForest = document.getElementById('filterOffForest').checked;
      
      if (hideOutOfService && resource.status === 'Out of Service') return false;
      if (hideOffForest && resource.status === 'Off Forest') return false;
      return true;
    }

    // Resource search functionality
    function createResourceSearchField(selectedResource = '', rowIndex = '') {
      const searchId = 'resource-search-' + rowIndex + '-' + Math.random().toString(36).substr(2, 5);
      const dropdownId = 'resource-dropdown-' + rowIndex + '-' + Math.random().toString(36).substr(2, 5);
      
      return `
        <div class="resource-search-container">
          <input 
            type="text" 
            class="resource-search-input" 
            id="${searchId}"
            value="${selectedResource}"
            placeholder="Type to search resources..."
            onkeyup="filterResources('${searchId}', '${dropdownId}')"
            onfocus="showResourceDropdown('${dropdownId}')"
            onblur="hideResourceDropdown('${dropdownId}')"
          >
          <div class="resource-dropdown" id="${dropdownId}"></div>
        </div>
      `;
    }

    function filterResources(inputId, dropdownId) {
      const input = document.getElementById(inputId);
      const dropdown = document.getElementById(dropdownId);
      if (!input || !dropdown) return;
      
      const searchTerm = input.value.toLowerCase();
      
      const filteredResources = resourceData.filter(resource => 
        resource.name.toLowerCase().includes(searchTerm) ||
        resource.type.toLowerCase().includes(searchTerm) ||
        resource.leader.toLowerCase().includes(searchTerm)
      );
      // You may want to populate the dropdown here, but for now just close the function
    }

    function applyFilters(columns) {
      const filterInputs = document.querySelectorAll('.filter-input');
      const filters = {};
      
      filterInputs.forEach((input, index) => {
        if (input.value.trim()) {
          filters[columns[index]] = input.value.toLowerCase();
        }
      });
      
      let sourceData = [];
      
      switch(currentDataTab) {
        case 'resources':
          sourceData = resourceData;
          break;
        case 'aviation':
          sourceData = [];
          Object.entries(aviationData).forEach(([wingType, aircraft]) => {
            aircraft.forEach(item => {
              sourceData.push({
                WingType: wingType,
                Type: item.Type,
                Resource: item.Resource,
                Status: item.Status,
                Location: item.Location,
                OnOff: item.OnOff
              });
            });
          });
          break;
        case 'personnel':
          sourceData = individualData;
          break;
      }
      
      filteredData = sourceData.filter(item => {
        return Object.keys(filters).every(key => {
          const value = item[key];
          return value && value.toString().toLowerCase().includes(filters[key]);
        });
      });
      
      renderDataTable(columns);
    }

    function clearFilters() {
      document.querySelectorAll('.filter-input').forEach(input => {
        input.value = '';
      });
      
      // Get columns from current tab
      let columns = [];
      switch(currentDataTab) {
        case 'resources':
          columns = ['type', 'name', 'leader', 'assigned', 'status', 'location', 'remarks'];
          break;
        case 'aviation':
          columns = ['WingType', 'Type', 'Resource', 'Status', 'Location', 'OnOff'];
          break;
        case 'personnel':
          columns = ['First', 'Last', 'Phone', 'Phone2', 'Email', 'Agency', 'Unit', 'Location', 'Title', 'ICSRole', 'AssignedTo', 'Lead', 'Remarks'];
          break;
      }
      applyFilters(columns);
    }

    function renderDataTable(columns) {
      const table = document.getElementById('dataTable');
      
      // Create header
      let headerHTML = '<thead><tr>';
      columns.forEach(col => {
        headerHTML += `<th>${col}</th>`;
      });
      headerHTML += '<th>Actions</th></tr></thead>';
      
      // Create body
      let bodyHTML = '<tbody>';
      filteredData.forEach((item, index) => {
        bodyHTML += '<tr>';
        columns.forEach(col => {
          const value = item[col] || '';
          bodyHTML += `<td>${createEditCell(col, value, index)}</td>`;
        });
        bodyHTML += `<td><button class="delete-btn" onclick="deleteRecord(${index})">Delete</button></td>`;
        bodyHTML += '</tr>';
      });
      bodyHTML += '</tbody>';
      
      table.innerHTML = headerHTML + bodyHTML;
    }

    function createEditCell(column, value, index) {
      switch(column) {
        case 'type':
          return `<select onchange="updateDataValue(${index}, '${column}', this.value)">${createSelectOptions([''].concat(resourceTypes), value)}</select>`;
        case 'status':
          if (currentDataTab === 'resources') {
            return `<select onchange="updateDataValue(${index}, '${column}', this.value)">${createSelectOptions([''].concat(statuses), value)}</select>`;
          } else {
            return `<select onchange="updateDataValue(${index}, '${column}', this.value)">${createSelectOptions(['', 'Available', 'Unavailable', 'Committed', 'Out of Service'], value)}</select>`;
          }
        case 'Agency':
          return `<select onchange="updateDataValue(${index}, '${column}', this.value)">${createSelectOptions([''].concat(agencies), value)}</select>`;
        case 'Unit':
          return `<select onchange="updateDataValue(${index}, '${column}', this.value)">${createSelectOptions([''].concat(units), value)}</select>`;
        case 'Location':
        case 'location':
          return `<select onchange="updateDataValue(${index}, '${column}', this.value)">${createSelectOptions([''].concat(locations), value)}</select>`;
        case 'Title':
          return `<select onchange="updateDataValue(${index}, '${column}', this.value)">${createSelectOptions([''].concat(titles), value)}</select>`;
        case 'ICSRole':
          return `<select onchange="updateDataValue(${index}, '${column}', this.value)">${createSelectOptions([''].concat(icsRoles), value)}</select>`;
        case 'WingType':
          return `<select onchange="updateDataValue(${index}, '${column}', this.value)">${createSelectOptions(['Rotor Wing', 'Fixed Wing'], value)}</select>`;
        case 'Lead':
          return `<select onchange="updateDataValue(${index}, '${column}', this.value)"><option value="Yes" ${value === 'Yes' ? 'selected' : ''}>Yes</option><option value="No" ${value === 'No' ? 'selected' : ''}>No</option></select>`;
        case 'assigned':
          return `<input type="number" value="${value}" onchange="updateDataValue(${index}, '${column}', this.value)">`;
        default:
          return `<input type="text" value="${value}" onchange="updateDataValue(${index}, '${column}', this.value)">`;
      }
    }

    function updateDataValue(index, column, value) {
      if (filteredData[index]) {
        filteredData[index][column] = value;
      }
    }

    function addNewRecord() {
      let newRecord = {};
      
      switch(currentDataTab) {
        case 'resources':
          newRecord = {
            type: '',
            name: '',
            leader: '',
            assigned: 0,
            status: 'In Service',
            location: '',
            remarks: ''
          };
          break;
        case 'aviation':
          newRecord = {
            WingType: 'Rotor Wing',
            Type: '',
            Resource: '',
            Status: 'Available',
            Location: '',
            OnOff: '0800-2000'
          };
          break;
        case 'personnel':
          newRecord = {
            First: '',
            Last: '',
            Phone: '',
            Phone2: '',
            Email: '',
            Agency: 'USFS',
            Unit: 'COFMS',
            Location: '',
            Title: '',
            ICSRole: 'FFT1',
            AssignedTo: '',
            Lead: 'No',
            Remarks: ''
          };
          break;
      }
      
      filteredData.push(newRecord);
      const columns = Object.keys(newRecord);
      renderDataTable(columns);
    }

    function deleteRecord(index) {
      if (confirm('Are you sure you want to delete this record?')) {
        filteredData.splice(index, 1);
        const columns = Object.keys(filteredData[0] || {});
        renderDataTable(columns);
      }
    }

    function saveDataChanges() {
      // Update the main data arrays with filtered data
      switch(currentDataTab) {
        case 'resources':
          resourceData = [...filteredData];
          break;
        case 'aviation':
          const newAviationData = { "Rotor Wing": [], "Fixed Wing": [] };
          filteredData.forEach(item => {
            const aircraft = {
              Type: item.Type,
              Resource: item.Resource,
              Status: item.Status,
              Location: item.Location,
              OnOff: item.OnOff
            };
            
            if (item.WingType === 'Rotor Wing') {
              newAviationData["Rotor Wing"].push(aircraft);
            } else {
              newAviationData["Fixed Wing"].push(aircraft);
            }
          });
          aviationData = newAviationData;
          break;
        case 'personnel':
          individualData = [...filteredData];
          break;
      }
      
      // Re-render the main page to reflect changes
      renderPage();
      alert('Changes saved successfully!');
    }

    function downloadCurrentData() {
      let filename = '';
      let headers = [];
      let rows = [];
      
      switch(currentDataTab) {
        case 'resources':
          filename = 'resources.csv';
          headers = ['type', 'name', 'leader', 'assigned', 'status', 'location', 'remarks'];
          rows = filteredData.map(item => headers.map(h => item[h] || ''));
          break;
        case 'aviation':
          filename = 'aviation.csv';
          headers = ['WingType', 'Type', 'Resource', 'Status', 'Location', 'OnOff'];
          rows = filteredData.map(item => headers.map(h => item[h] || ''));
          break;
        case 'personnel':
          filename = 'individuals.csv';
          headers = ['First', 'Last', 'Phone', 'Phone2', 'Email', 'Agency', 'Unit', 'Location', 'Title', 'ICSRole', 'AssignedTo', 'Lead', 'Remarks'];
          rows = filteredData.map(item => headers.map(h => item[h] || ''));
          break;
      }
      
      const csvContent = [headers, ...rows].map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
      ).join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // CSV Upload functionality
    document.getElementById('csvUpload').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.trim().split('\n');
          const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
          
          const newData = [];
          for (let i = 1; i < lines.length; i++) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let j = 0; j < lines[i].length; j++) {
              const char = lines[i][j];
              if (char === '"') {
                inQuotes = !inQuotes;
              } else if (char === ',' && !inQuotes) {
                values.push(current.trim());
                current = '';
              } else {
                current += char;
              }
            }
            values.push(current.trim());
            
            const row = {};
            headers.forEach((header, index) => {
              row[header] = values[index] ? values[index].replace(/^"|"$/g, '') : '';
            });
            newData.push(row);
          }
          
          filteredData = newData;
          renderDataTable(headers);
          alert('CSV loaded successfully!');
        } catch (error) {
          alert('Error loading CSV: ' + error.message);
        }
      };
      reader.readAsText(file);
    });

    // Data transformation and rendering
    function getStaffingData() {
      const divisionMap = new Map();
      
      divisions.forEach(divName => {
        divisionMap.set(divName, {
          name: divName,
          dutyOfficer: '',
          agencyAdmins: [],
          lastModified: new Date().toLocaleString(),
          resources: []
        });
      });
      
      individualData.forEach(person => {
        const location = person.Location || 'Unassigned';
        const divName = divisions.find(d => d.includes(location)) || location;
        
        if (!divisionMap.has(divName)) {
          divisionMap.set(divName, {
            name: divName,
            dutyOfficer: '',
            agencyAdmins: [],
            lastModified: new Date().toLocaleString(),
            resources: []
          });
        }
        
        const division = divisionMap.get(divName);
        if (person.ICSRole === 'AA' || person.ICSRole === 'AR') {
          division.agencyAdmins.push(`${person.First} ${person.Last} (${person.Phone}${person.Phone2 ? ' / ' + person.Phone2 : ''}, ${person.Email})`);
        }
      });

      resourceData.forEach(resource => {
        const location = resource.location || 'Unassigned';
        const divName = divisions.find(d => d.includes(location)) || location;
        
        if (divisionMap.has(divName)) {
          const division = divisionMap.get(divName);
          division.resources.push({
            type: resource.type,
            name: resource.name,
            leader: resource.leader,
            assigned: resource.assigned,
            status: resource.status,
            location: resource.location,
            remarks: resource.remarks
          });
          
          if (resource.type === 'Duty Officer') {
            division.dutyOfficer = resource.leader;
          }
        }
      });

      divisionMap.forEach(division => {
        division.resources.sort((a, b) => {
          const statusOrder = ['Late Resource', 'In Service', 'Delayed Response', 'Committed', 'Off Forest', 'Out of Service'];
          const aIndex = statusOrder.indexOf(a.status) === -1 ? 999 : statusOrder.indexOf(a.status);
          const bIndex = statusOrder.indexOf(b.status) === -1 ? 999 : statusOrder.indexOf(b.status);
          return aIndex - bIndex;
        });
      });

      return Array.from(divisionMap.values());
    }

    function getCOFMSDutyOfficer() {
      const cofmsResource = resourceData.find(r => 
        r.type === 'Duty Officer' && r.name && r.name.includes('COFMS')
      );
      
      if (cofmsResource) {
        const individual = individualData.find(i => 
          `${i.First} ${i.Last}` === cofmsResource.leader
        );
        if (individual) {
          return `${individual.First} ${individual.Last}<br>Phone: ${individual.Phone}${individual.Phone2 ? ' / ' + individual.Phone2 : ''}<br>Email: ${individual.Email}`;
        }
        return cofmsResource.leader;
      }
      return 'None Assigned';
    }

    function renderPage() {
      const staffingContainer = document.getElementById('staffing-container');
      const aviationContainer = document.getElementById('aviation-container');
      const dutyOfficerDiv = document.getElementById('cofms-duty-officer');

      // Clear edit mode
      document.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('edit-mode'));

      dutyOfficerDiv.innerHTML = getCOFMSDutyOfficer();
      staffingContainer.innerHTML = '';
      
      const staffingData = getStaffingData();

      staffingData.forEach(division => {
        const section = document.createElement('div');
        section.className = 'division-section';

        const resourcesHTML = division.resources
          .filter(shouldShowResource)
          .map(r => `
            <tr class="${getStatusClass(r.status)}" title="${r.remarks || ''}">
              <td>${r.type}</td>
              <td>${r.name}</td>
              <td>${r.leader}</td>
              <td>${r.assigned}</td>
              <td>${r.status}</td>
              <td>${r.location}</td>
              <td>${r.remarks}</td>
            </tr>
          `).join('');

        section.innerHTML = `
          <div class="division-header">
            <h3>${division.name}</h3>
            <div class="division-meta">
              Last Modified: ${division.lastModified}<br>
              ${division.agencyAdmins.length ? `Agency Admin(s):<br>${division.agencyAdmins.join('<br>')}` : ''}
            </div>
          </div>
          ${division.dutyOfficer ? `<div class="duty-info"><strong>Duty Officer:</strong> ${division.dutyOfficer}</div>` : ''}
          <table class="division-table">
            <thead>
              <tr><th>Type</th><th>Resource</th><th>Leader</th><th>Assigned</th><th>Status</th><th>Location</th><th>Remarks</th></tr>
            </thead>
            <tbody>
              ${resourcesHTML || `<tr><td colspan="7"><em>No resources shown with current filters.</em></td></tr>`}
            </tbody>
          </table>
        `;

        staffingContainer.appendChild(section);
      });

      // Rebuild aviation section
      aviationContainer.innerHTML = '';
      Object.entries(aviationData).forEach(([wingType, resources]) => {
        const section = document.createElement('div');
        section.className = 'aviation-table-section';
        section.innerHTML = `
          <h3>${wingType}</h3>
          <table class="aviation-table">
            <thead>
              <tr><th>Type</th><th>Resource</th><th>Status</th><th>Location</th><th>On/Off</th></tr>
            </thead>
            <tbody>
              ${resources.map(r => `
                <tr class="${getStatusClass(r.Status)}" title="${r.Type || ''}">
                  <td>${r.Type}</td>
                  <td>${r.Resource}</td>
                  <td>${r.Status}</td>
                  <td>${r.Location}</td>
                  <td>${r.OnOff}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        aviationContainer.appendChild(section);
      });
    }

    // Load data from JSON files if available
    async function loadJSONFiles() {
      try {
        try {
          const individualsResponse = await fetch('data/individuals.json');
          if (individualsResponse.ok) {
            individualData = await individualsResponse.json();
          }
        } catch (e) { /* Use default data */ }

        try {
          const resourcesResponse = await fetch('data/resources.json');
          if (resourcesResponse.ok) {
            const loadedResources = await resourcesResponse.json();
            resourceData = loadedResources.map(resource => ({
              type: resource.type || resource.ResourceType || '',
              name: resource.name || resource.ResourceName || '',
              leader: resource.leader || resource.Leader || '',
              assigned: resource.assigned || resource.Assigned || 0,
              status: resource.status || resource.Status || 'In Service',
              location: resource.location || resource.Location || '',
              remarks: resource.remarks || resource.Remarks || ''
            }));
          }
        } catch (e) { /* Use default data */ }

        try {
          const aviationResponse = await fetch('data/aviation.json');
          if (aviationResponse.ok) {
            aviationData = await aviationResponse.json();
          }
        } catch (e) { /* Use default data */ }

      } catch (error) {
        console.error('Error loading JSON files:', error);
      }

      renderPage();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', loadJSONFiles);

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.resource-search-container')) {
        document.querySelectorAll('.resource-dropdown').forEach(dropdown => {
          dropdown.style.display = 'none';
        });
      }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('dataEditorModal');
      if (event.target === modal) {
        closeDataEditor();
      }
    };

  </script>
</body>
</html>