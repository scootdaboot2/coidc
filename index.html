<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Central Oregon Staffing</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f8f8;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .main-content {
      display: flex;
      gap: 20px;
    }
    .division-column {
      flex: 3;
    }
    .aviation-column {
      flex: 1;
    }
    .division-section, .aviation-table-section {
      margin-bottom: 30px;
      background: #fff;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .division-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    .division-meta {
      font-size: 0.8em;
      text-align: right;
      line-height: 1.4;
      color: #666;
    }
    .duty-info {
      margin: 10px 0;
      padding: 8px;
      background: #f9f9f9;
      border-left: 4px solid #2196f3;
      font-size: 0.9em;
    }
    .division-table, .aviation-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .division-table th, .division-table td,
    .aviation-table th, .aviation-table td {
      border: 1px solid #ddd;
      padding: 8px 10px;
      text-align: left;
    }
    .division-table th, .aviation-table th {
      background-color: #f5f5f5;
      font-weight: bold;
    }
    .btn.update-btn {
      padding: 4px 8px;
      background: #ddd;
      color: #666;
      border: none;
      cursor: pointer;
      border-radius: 3px;
      font-size: 11px;
      margin-top: 5px;
    }
    .btn.update-btn:hover {
      background: #ccc;
    }
    .edit-input, .edit-select {
      width: 100%;
      box-sizing: border-box;
      padding: 4px;
      border: 1px solid #ccc;
    }
    .add-btn, .save-btn {
      background: #2e7d32;
      color: #fff;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      margin: 6px 4px 6px 0;
      border-radius: 3px;
    }
    .add-btn:hover, .save-btn:hover {
      background: #1b5e20;
    }
    .delete-btn {
      background: #c62828;
      color: #fff;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 3px;
    }
    .delete-btn:hover {
      background: #8e0000;
    }
    .status-late {
      background-color: #ffebee !important;
      color: #c62828;
      font-weight: bold;
    }
    .status-out {
      color: #666;
      font-style: italic;
    }
    .status-committed {
      background-color: #fff3e0 !important;
      color: #ef6c00;
    }
    .status-delayed {
      background-color: #fff8e1 !important;
      color: #f57c00;
    }
    .csv-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: none;
    }
    .csv-controls.show {
      display: block;
    }
    .csv-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 4px;
    }
    .csv-btn {
      padding: 4px 8px;
      font-size: 11px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      white-space: nowrap;
    }
    .csv-btn.download {
      background: #4caf50;
      color: white;
    }
    .csv-btn.upload {
      background: #2196f3;
      color: white;
    }
    .csv-btn:hover {
      opacity: 0.8;
    }
    .filter-controls {
      margin: 10px 0;
    }
    .filter-controls label {
      margin-right: 15px;
    }
    .cofms-header {
      background: #e3f2fd;
      border: 2px solid #1976d2;
      text-align: center;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 5px;
    }
    .cofms-header h2 {
      margin: 0 0 10px 0;
      color: #1976d2;
    }
    .data-management-btn {
      background: #ff9800;
      color: white;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 3px;
      margin: 6px 4px;
    }
    .data-management-btn:hover {
      background: #f57c00;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 1200px;
      border-radius: 5px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .modal-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    .modal-table th, .modal-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .modal-table th {
      background-color: #f2f2f2;
    }
    .filter-input {
      margin: 5px;
      padding: 4px;
      border: 1px solid #ccc;
    }
    .data-tab-active {
      background: #1976d2 !important;
    }
    .data-content-section {
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>Central Oregon Staffing</h1>
  
  <div class="csv-controls" id="csvControls">
    <div class="csv-buttons">
      <button class="csv-btn download" onclick="downloadCSV('individuals')">↓ Individuals</button>
      <button class="csv-btn download" onclick="downloadCSV('resources')">↓ Resources</button>
      <button class="csv-btn download" onclick="downloadCSV('aviation')">↓ Aviation</button>
      <input type="file" id="uploadIndividuals" style="display:none" accept=".csv" onchange="uploadCSV(event, 'individuals')">
      <button class="csv-btn upload" onclick="document.getElementById('uploadIndividuals').click()">↑ Individuals</button>
      <input type="file" id="uploadResources" style="display:none" accept=".csv" onchange="uploadCSV(event, 'resources')">
      <button class="csv-btn upload" onclick="document.getElementById('uploadResources').click()">↑ Resources</button>
      <input type="file" id="uploadAviation" style="display:none" accept=".csv" onchange="uploadCSV(event, 'aviation')">
      <button class="csv-btn upload" onclick="document.getElementById('uploadAviation').click()">↑ Aviation</button>
    </div>
  </div>
  
  <div class="cofms-header">
    <h2>COFMS Duty Officer</h2>
    <div id="cofms-duty-officer">Loading data...</div>
  </div>

  <div class="filter-controls">
    <label><input type="checkbox" id="filterOutOfService" checked> Hide Out of Service</label>
    <label><input type="checkbox" id="filterOffForest"> Hide Off Forest</label>
    <button class="update-btn" onclick="renderPage()">Apply Filters</button>
  </div>

  <div class="main-content">
    <div id="staffing-container" class="division-column"></div>
    <div id="aviation-container" class="aviation-column"></div>
  </div>

  <!-- Data Management Modal -->
  <div id="dataManagerModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('dataManagerModal')">&times;</span>
      <h2>Data Manager</h2>
      
      <div style="margin-bottom: 20px;">
        <button class="data-management-btn" onclick="switchDataTab('individuals')" id="individualsTab">Individuals</button>
        <button class="data-management-btn" onclick="switchDataTab('resources')" id="resourcesTab">Resources</button>
        <button class="data-management-btn" onclick="switchDataTab('aviation')" id="aviationTab">Aviation</button>
      </div>
      
      <div id="dataContent">
        <!-- Dynamic content will be loaded here -->
      </div>
      
      <div style="margin-top: 20px;">
        <button class="add-btn" onclick="addDataRow()">+ Add New</button>
        <button class="save-btn" onclick="saveDataChanges()">Save All Changes</button>
      </div>
    </div>
  </div>

  <script>
    // Global edit state
    let isEditMode = false;

    // Data storage - initialize empty, will load from JSON files
    let individualData = [];
    let resourceData = [];
    let aviationData = { "Rotor Wing": [], "Fixed Wing": [] };

    // Load JSON files on startup
    async function loadJSONFiles() {
      console.log('Starting to load JSON files...');
      
      try {
        // Set default/sample data first
        individualData = [
          {
            "First": "Jane",
            "Last": "Smith",
            "Phone": "541-555-1234",
            "Phone2": "541-555-5678",
            "Email": "jane.smith@example.com",
            "Agency": "USFS",
            "Unit": "COFMS",
            "Location": "Cascade Division",
            "Title": "USFS-IC",
            "ICSRole": "AA",
            "AssignedTo": "OR-DEF-BC41",
            "Lead": "Yes",
            "Remarks": ""
          }
        ];

        resourceData = [
          {
            "ResourceType": "Duty Officer",
            "ResourceName": "OR-DEF-BC41",
            "Leader": "Jane Smith",
            "Assigned": 1,
            "Status": "In Service",
            "Location": "Cascade Division",
            "Remarks": "Covering east side"
          }
        ];

        aviationData = {
          "Rotor Wing": [
            {
              "Type": "HEL T1",
              "Resource": "N1234H",
              "Status": "Available",
              "Location": "Redmond",
              "OnOff": "0800-2000"
            }
          ],
          "Fixed Wing": [
            {
              "Type": "SEAT",
              "Resource": "N5678F",
              "Status": "Unavailable",
              "Location": "Prineville",
              "OnOff": "0800-2000"
            }
          ]
        };

        // Try to load actual JSON files (with timeout)
        const timeout = 3000; // 3 second timeout
        
        const loadWithTimeout = (url) => {
          return Promise.race([
            fetch(url),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error('Timeout')), timeout)
            )
          ]);
        };

        try {
          console.log('Attempting to load /nwcc/districts/COIDC/Testing_Site/individuals.json...');
          const individualsResponse = await loadWithTimeout('/Testing_Site/individuals.json');
          if (individualsResponse.ok) {
            individualData = await individualsResponse.json();
            console.log('✓ individuals.json loaded successfully');
          }
        } catch (error) {
          console.log('individuals.json not found or failed to load, using sample data');
        }

        try {
          console.log('Attempting to load /nwcc/districts/COIDC/Testing_Site/resources.json...');
          const resourcesResponse = await loadWithTimeout('/Testing_Site/resources.json');
          if (resourcesResponse.ok) {
            resourceData = await resourcesResponse.json();
            console.log('✓ resources.json loaded successfully');
          }
        } catch (error) {
          console.log('resources.json not found or failed to load, using sample data');
        }

        try {
          console.log('Attempting to load /nwcc/districts/COIDC/Testing_Site/aviation.json...');
          const aviationResponse = await loadWithTimeout('/Testing_Site/aviation.json');
          if (aviationResponse.ok) {
            aviationData = await aviationResponse.json();
            console.log('✓ aviation.json loaded successfully');
          }
        } catch (error) {
          console.log('aviation.json not found or failed to load, using sample data');
        }

      } catch (error) {
        console.error('Error during JSON loading:', error);
      }

      // Always render the page, whether files loaded or not
      console.log('Rendering page with available data...');
      renderPage();
      console.log('Page loaded successfully!');
    }

    // Configuration arrays
    const divisions = [
      "Cascade Division", "Crescent Division", "Newberry East", "Newberry West", 
      "Rivers Division", "Prairie Division", "ODF Prineville", "ODF Sisters", "ODF Fossil"
    ];

    const agencies = ["USFS", "BLM", "ODF"];
    
    const units = [
      "Prineville FO", "Deschutes FO", "Central Oregon", "DEF-Bend", "DEF-Sisters", 
      "DEF-Crescent", "OCF-Prineville", "COFMS"
    ];

    const locations = [
      "Cascade", "Crescent", "Newberry East", "Newberry West", "Rivers", "Prairie", 
      "ODF Sisters", "ODF Prineville", "ODF Fossil", "ODF John Day", "BIAK", "Walker Range"
    ];

    const titles = [
      "BLM-Prineville District Manager", "BLM-Deschutes Field Manager", 
      "BLM-Central Oregon Manager", "USFS-IC", "FMO", "BC", "Operations"
    ];

    const icsRoles = ["FFT1", "FFT2", "TFLD", "DIVS", "AA", "AR"];

    const resourceTypes = [
      "Duty Officer", "Overhead (FMO)", "Overhead (FT)", "Overhead (BC)", "Prevention", 
      "Lookout", "ENG T3", "ENG T5", "ENG T6", "Overhead (FOS)", "CRWT2 IA", "CRWT2", 
      "IHC", "WFMT1", "WFMT2", "HEL T1", "HEL T2", "HEL T3", "DOZ T1", "DOZ T2", 
      "DOZ T3", "WTS T1", "WTS T2", "WTS T3", "IA MOD", "Severity", "Support"
    ];

    const statuses = ["In Service", "Delayed Response", "Out of Service", "Off Forest", "Late Resource", "Committed"];

    // Helper functions
    function createSelectOptions(array, selected = '', allowCustom = false) {
      let options = array.map(item => 
        `<option value="${item}" ${item === selected ? 'selected' : ''}>${item}</option>`
      ).join('');
      
      if (allowCustom && selected && !array.includes(selected)) {
        options += `<option value="${selected}" selected>${selected}</option>`;
      }
      
      return options;
    }

    function createEditableSelect(array, selected = '', allowCustom = false) {
      if (allowCustom) {
        return `<input class="edit-input" list="datalist_${Math.random().toString(36).substr(2, 9)}" value="${selected}">
                <datalist id="datalist_${Math.random().toString(36).substr(2, 9)}">
                  ${array.map(item => `<option value="${item}">`).join('')}
                </datalist>`;
      } else {
        return `<select class="edit-select">${createSelectOptions(array, selected)}</select>`;
      }
    }

    function getStatusClass(status) {
      switch(status) {
        case 'Late Resource': return 'status-late';
        case 'Out of Service': return 'status-out';
        case 'Committed': return 'status-committed';
        case 'Delayed Response': return 'status-delayed';
        default: return '';
      }
    }

    function sortResourcesByStatus(resources) {
      const statusOrder = ['Late Resource', 'In Service', 'Delayed Response', 'Committed', 'Off Forest', 'Out of Service'];
      return resources.sort((a, b) => {
        const aIndex = statusOrder.indexOf(a.Status) === -1 ? 999 : statusOrder.indexOf(a.Status);
        const bIndex = statusOrder.indexOf(b.Status) === -1 ? 999 : statusOrder.indexOf(b.Status);
        return aIndex - bIndex;
      });
    }

    function shouldShowResource(resource) {
      const hideOutOfService = document.getElementById('filterOutOfService').checked;
      const hideOffForest = document.getElementById('filterOffForest').checked;
      
      if (hideOutOfService && resource.Status === 'Out of Service') return false;
      if (hideOffForest && resource.Status === 'Off Forest') return false;
      return true;
    }

    // Auto-population functions
    function getIndividualByName(name) {
      return individualData.find(person => `${person.First} ${person.Last}` === name);
    }

    function getResourceByName(name) {
      return resourceData.find(resource => resource.ResourceName === name);
    }

    function populateFromIndividual(row, individual) {
      if (!individual) return;
      
      const locationSelect = row.querySelector('select:nth-of-type(4)'); // Location select
      if (locationSelect && individual.Location) {
        locationSelect.value = individual.Location;
      }
    }

    function populateFromResource(row, resource) {
      if (!resource) return;
      
      const typeSelect = row.querySelector('select:nth-of-type(1)');
      const assignedInput = row.querySelector('input[type="number"]');
      const statusSelect = row.querySelector('select:nth-of-type(3)');
      const locationSelect = row.querySelector('select:nth-of-type(4)');
      const remarksInput = row.querySelector('input:last-of-type');
      
      if (typeSelect && resource.ResourceType) typeSelect.value = resource.ResourceType;
      if (assignedInput && resource.Assigned) assignedInput.value = resource.Assigned;
      if (statusSelect && resource.Status) statusSelect.value = resource.Status;
      if (locationSelect && resource.Location) locationSelect.value = resource.Location;
      if (remarksInput && resource.Remarks) remarksInput.value = resource.Remarks;
    }

    // Data transformation
    function getStaffingData() {
      const divisionMap = new Map();
      
      // Initialize all divisions
      divisions.forEach(divName => {
        divisionMap.set(divName, {
          name: divName,
          dutyOfficer: '',
          agencyAdmins: [],
          lastModified: new Date().toLocaleString(),
          resources: []
        });
      });
      
      // Add individuals to divisions
      individualData.forEach(person => {
        const location = person.Location || 'Unassigned';
        const divName = divisions.find(d => d.includes(location)) || location;
        
        if (!divisionMap.has(divName)) {
          divisionMap.set(divName, {
            name: divName,
            dutyOfficer: '',
            agencyAdmins: [],
            lastModified: new Date().toLocaleString(),
            resources: []
          });
        }
        
        const division = divisionMap.get(divName);
        if (person.ICSRole === 'AA' || person.ICSRole === 'AR') {
          division.agencyAdmins.push(`${person.First} ${person.Last} (${person.Phone}${person.Phone2 ? ' / ' + person.Phone2 : ''}, ${person.Email})`);
        }
      });

      // Add resources to divisions and find duty officers
      resourceData.forEach(resource => {
        const location = resource.Location || 'Unassigned';
        const divName = divisions.find(d => d.includes(location)) || location;
        
        if (divisionMap.has(divName)) {
          const division = divisionMap.get(divName);
          division.resources.push({
            type: resource.ResourceType,
            name: resource.ResourceName,
            leader: resource.Leader,
            assigned: resource.Assigned,
            status: resource.Status,
            location: resource.Location,
            remarks: resource.Remarks
          });
          
          if (resource.ResourceType === 'Duty Officer') {
            division.dutyOfficer = resource.Leader;
          }
        }
      });

      // Sort resources by status for each division
      divisionMap.forEach(division => {
        division.resources = sortResourcesByStatus(division.resources);
      });

      return Array.from(divisionMap.values());
    }

    function getCOFMSDutyOfficer() {
      const cofmsResource = resourceData.find(r => 
        r.ResourceType === 'Duty Officer' && r.ResourceName.includes('COFMS')
      );
      
      if (cofmsResource) {
        const individual = individualData.find(i => 
          `${i.First} ${i.Last}` === cofmsResource.Leader
        );
        if (individual) {
          return `${individual.First} ${individual.Last}<br>Phone: ${individual.Phone}${individual.Phone2 ? ' / ' + individual.Phone2 : ''}<br>Email: ${individual.Email}`;
        }
        return cofmsResource.Leader;
      }
      return 'None Assigned';
    }

    // CSV handling functions
    function downloadCSV(type) {
      let rows = [];
      let filename = '';
      
      switch(type) {
        case 'individuals':
          rows.push(['First', 'Last', 'Phone', 'Phone2', 'Email', 'Agency', 'Unit', 'Location', 'Title', 'ICSRole', 'AssignedTo', 'Lead', 'Remarks']);
          individualData.forEach(person => {
            rows.push([
              person.First || '', person.Last || '', person.Phone || '', person.Phone2 || '',
              person.Email || '', person.Agency || '', person.Unit || '', person.Location || '',
              person.Title || '', person.ICSRole || '', person.AssignedTo || '', person.Lead || '', person.Remarks || ''
            ]);
          });
          filename = 'individuals.csv';
          break;
          
        case 'resources':
          rows.push(['ResourceType', 'ResourceName', 'Leader', 'Assigned', 'Status', 'Location', 'Remarks']);
          resourceData.forEach(resource => {
            rows.push([
              resource.ResourceType || '', resource.ResourceName || '', resource.Leader || '',
              resource.Assigned || '', resource.Status || '', resource.Location || '', resource.Remarks || ''
            ]);
          });
          filename = 'resources.csv';
          break;
          
        case 'aviation':
          rows.push(['Type', 'Resource', 'Status', 'Location', 'OnOff']);
          Object.entries(aviationData).forEach(([type, resources]) => {
            resources.forEach(resource => {
              rows.push([type, resource.Resource || '', resource.Status || '', resource.Location || '', resource.OnOff || '']);
            });
          });
          filename = 'aviation.csv';
          break;
      }
      
      const csv = rows.map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
      ).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function uploadCSV(event, type) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.trim().split('\n');
          const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
          
          const newData = [];
          for (let i = 1; i < lines.length; i++) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            // Parse CSV properly handling quoted values
            for (let j = 0; j < lines[i].length; j++) {
              const char = lines[i][j];
              if (char === '"') {
                inQuotes = !inQuotes;
              } else if (char === ',' && !inQuotes) {
                values.push(current.trim());
                current = '';
              } else {
                current += char;
              }
            }
            values.push(current.trim()); // Add the last value
            
            const row = {};
            headers.forEach((header, index) => {
              row[header] = values[index] ? values[index].replace(/^"|"$/g, '') : '';
            });
            newData.push(row);
          }
          
          switch(type) {
            case 'individuals':
              individualData = newData;
              break;
            case 'resources':
              resourceData = newData;
              break;
            case 'aviation':
              // Convert flat CSV back to nested structure
              const newAviationData = { "Rotor Wing": [], "Fixed Wing": [] };
              newData.forEach(row => {
                const aviationItem = {
                  Resource: row.Resource || '',
                  Status: row.Status || '',
                  Location: row.Location || '',
                  OnOff: row.OnOff || ''
                };
                
                if (row.Type === 'Rotor Wing') {
                  aviationItem.Type = 'HEL T1';
                  newAviationData["Rotor Wing"].push(aviationItem);
                } else if (row.Type === 'Fixed Wing') {
                  aviationItem.Type = 'SEAT';
                  newAviationData["Fixed Wing"].push(aviationItem);
                }
              });
              aviationData = newAviationData;
              break;
          }
          
          renderPage();
          alert(`${type} CSV loaded successfully!`);
        } catch (error) {
          alert(`Error loading ${type} CSV: ${error.message}`);
        }
      };
      reader.readAsText(file);
    }

    // Edit functions
    function toggleEditMode() {
      isEditMode = !isEditMode;
      const csvControls = document.getElementById('csvControls');
      if (isEditMode) {
        csvControls.classList.add('show');
      } else {
        csvControls.classList.remove('show');
      }
    }

    function createEditableRow(resource) {
      // Get all individuals for leader dropdown
      const leaders = individualData.map(i => `${i.First} ${i.Last}`);
      const resourceNames = resourceData.map(r => r.ResourceName);
      
      return `
        <tr>
          <td><select class="edit-select">${createSelectOptions(resourceTypes, resource.type, true)}</select></td>
          <td>
            <select class="edit-select" onchange="handleResourceNameChange(this)">
              <option value="">New Resource</option>
              ${createSelectOptions(resourceNames, resource.name)}
            </select>
            <input class="edit-input" value="${resource.name}" style="margin-top: 2px;" placeholder="Resource Name">
          </td>
          <td>
            <select class="edit-select" onchange="handleLeaderChange(this)">
              <option value="">Select Leader</option>
              ${createSelectOptions(leaders, resource.leader)}
            </select>
          </td>
          <td><input class="edit-input" type="number" value="${resource.assigned}" /></td>
          <td><select class="edit-select">${createSelectOptions(statuses, resource.status)}</select></td>
          <td><input class="edit-input" list="locationsList" value="${resource.location}">
              <datalist id="locationsList">${locations.map(loc => `<option value="${loc}">`).join('')}</datalist></td>
          <td><input class="edit-input" value="${resource.remarks}" /></td>
          <td><button class="delete-btn" onclick="this.closest('tr').remove()">✖</button></td>
        </tr>
      `;
    }

    function handleLeaderChange(select) {
      const row = select.closest('tr');
      const leaderName = select.value;
      const individual = getIndividualByName(leaderName);
      if (individual) {
        populateFromIndividual(row, individual);
      }
    }

    function handleResourceNameChange(select) {
      const row = select.closest('tr');
      const resourceName = select.value;
      const nameInput = row.querySelector('input[placeholder="Resource Name"]');
      
      if (resourceName) {
        nameInput.value = resourceName;
        const resource = getResourceByName(resourceName);
        if (resource) {
          populateFromResource(row, resource);
        }
      }
    }

    function toggleDivisionEdit(div, divisionData) {
      toggleEditMode();
      
      const table = div.querySelector('table');
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = divisionData.resources.map(res => createEditableRow(res)).join('');

      const addBtn = document.createElement('button');
      addBtn.className = 'add-btn';
      addBtn.textContent = '+ Add Resource';
      addBtn.onclick = () => {
        const tr = document.createElement('tr');
        tr.innerHTML = createEditableRow({ type: '', name: '', leader: '', assigned: 1, status: 'In Service', location: divisionData.name, remarks: '' });
        tbody.appendChild(tr);
      };

      const dataManageBtn = document.createElement('button');
      dataManageBtn.className = 'data-management-btn';
      dataManageBtn.textContent = 'Update Inputs';
      dataManageBtn.onclick = () => openDataManager();

      const aviationManageBtn = document.createElement('button');
      aviationManageBtn.className = 'data-management-btn';
      dataManageBtn.textContent = 'Aviation';
      aviationManageBtn.onclick = () => toggleAviationEdit();

      const prevAdd = div.querySelector('.add-btn');
      if (prevAdd) prevAdd.remove();
      const prevDataManage = div.querySelector('.data-management-btn');
      if (prevDataManage) prevDataManage.remove();
      
      table.insertAdjacentElement('beforebegin', addBtn);
      table.insertAdjacentElement('beforebegin', dataManageBtn);
      table.insertAdjacentElement('beforebegin', aviationManageBtn);
      
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save-btn';
      saveBtn.textContent = 'Save Section';
      saveBtn.onclick = () => {
        const updatedRows = [];
        tbody.querySelectorAll('tr').forEach(row => {
          const selects = row.querySelectorAll('select');
          const inputs = row.querySelectorAll('input');
          if (selects.length && inputs.length) {
            const nameInput = row.querySelector('input[placeholder="Resource Name"]');
            updatedRows.push({
              type: selects[0].value,
              name: nameInput.value,
              leader: selects[2].value,
              assigned: parseInt(inputs[1].value) || 1,
              status: selects[3].value,
              location: inputs[2].value,
              remarks: inputs[3].value
            });
          }
        });

        // Update resourceData
        resourceData = resourceData.filter(r => r.Location !== divisionData.name);
        updatedRows.forEach(row => {
          if (row.name) {
            resourceData.push({
              ResourceType: row.type,
              ResourceName: row.name,
              Leader: row.leader,
              Assigned: row.assigned,
              Status: row.status,
              Location: row.location,
              Remarks: row.remarks
            });
          }
        });

        renderPage();
        alert('Division saved! Use "↓ Resources" to download updated CSV.');
      };

      div.appendChild(saveBtn);
    }

    // Aviation edit functions
    function createEditableAviationRow(resource) {
      return `
        <tr>
          <td><select class="edit-select">${createSelectOptions(['Rotor Wing', 'Fixed Wing'], resource.type)}</select></td>
          <td><input class="edit-input" value="${resource.resource}" /></td>
          <td><select class="edit-select">${createSelectOptions(['Available', 'Unavailable', 'Committed', 'Out of Service'], resource.status)}</select></td>
          <td><input class="edit-input" list="locationsList" value="${resource.location}">
              <datalist id="locationsList">${locations.map(loc => `<option value="${loc}">`).join('')}</datalist></td>
          <td><input class="edit-input" value="${resource.onoff}" placeholder="0800-2000" /></td>
          <td><button class="delete-btn" onclick="this.closest('tr').remove()">✖</button></td>
        </tr>
      `;
    }

    function toggleAviationEdit() {
      const aviationEl = document.getElementById('aviation-container');
      aviationEl.innerHTML = '';

      const section = document.createElement('div');
      section.className = 'aviation-section';
      section.innerHTML = '<h2>Aviation Resources (Edit Mode)</h2>';

      const aviationResources = [];
      Object.entries(aviationData).forEach(([type, resources]) => {
        resources.forEach(resource => {
          aviationResources.push({
            type: type,
            resource: resource.Resource,
            status: resource.Status,
            location: resource.Location,
            onoff: resource.OnOff
          });
        });
      });
      
      ['Rotor Wing', 'Fixed Wing'].forEach(type => {
        const data = aviationResources.filter(r => r.type === type);
        const wrapper = document.createElement('div');
        wrapper.className = 'aviation-table-section';

        const table = document.createElement('table');
        table.className = 'aviation-table';
        table.innerHTML = `
          <thead><tr><th colspan="6">${type}</th></tr>
          <tr><th>Type</th><th>Resource</th><th>Status</th><th>Location</th><th>On/Off</th><th></th></tr></thead>
          <tbody>
            ${data.map(row => createEditableAviationRow(row)).join('')}
          </tbody>
        `;

        const addBtn = document.createElement('button');
        addBtn.className = 'add-btn';
        addBtn.textContent = `+ Add ${type}`;
        addBtn.onclick = () => {
          const tr = document.createElement('tr');
          tr.innerHTML = createEditableAviationRow({ type: type, resource: '', status: 'Available', location: 'Redmond', onoff: '0800-2000' });
          table.querySelector('tbody').appendChild(tr);
        };

        wrapper.appendChild(addBtn);
        wrapper.appendChild(table);
        section.appendChild(wrapper);
      });

      const saveBtn = document.createElement('button');
      saveBtn.className = 'save-btn';
      saveBtn.textContent = 'Save Aviation';
      saveBtn.onclick = () => {
        const newAviationData = { "Rotor Wing": [], "Fixed Wing": [] };
        
        section.querySelectorAll('tbody tr').forEach(row => {
          const selects = row.querySelectorAll('select');
          const inputs = row.querySelectorAll('input');
          if (selects.length && inputs.length && inputs[0].value) {
            const type = selects[0].value;
            const resource = {
              Type: type === 'Rotor Wing' ? 'HEL T1' : 'SEAT',
              Resource: inputs[0].value,
              Status: selects[1].value,
              Location: inputs[1].value,
              OnOff: inputs[2].value
            };
            
            if (type === 'Rotor Wing') {
              newAviationData["Rotor Wing"].push(resource);
            } else {
              newAviationData["Fixed Wing"].push(resource);
            }
          }
        });

        aviationData = newAviationData;
        renderPage();
        alert('Aviation saved! Use "↓ Aviation" to download updated CSV.');
      };

      section.appendChild(saveBtn);
      aviationEl.appendChild(section);
    }

    // Data Management Modal Functions
    let currentDataTab = 'individuals';

    function openDataManager() {
      openModal('dataManagerModal');
      switchDataTab('individuals');
    }

    function switchDataTab(tab) {
      currentDataTab = tab;
      
      // Update tab buttons
      document.querySelectorAll('[id$="Tab"]').forEach(btn => btn.classList.remove('data-tab-active'));
      document.getElementById(tab + 'Tab').classList.add('data-tab-active');
      
      // Load content for selected tab
      loadDataContent(tab);
    }

    function loadDataContent(tab) {
      const container = document.getElementById('dataContent');
      let html = '<div class="data-content-section">';
      
      switch(tab) {
        case 'individuals':
          html += `
            <table class="modal-table">
              <thead>
                <tr>
                  <th>First</th><th>Last</th><th>Phone</th><th>Phone2</th><th>Email</th>
                  <th>Agency</th><th>Unit</th><th>Location</th><th>Title</th><th>ICS Role</th>
                  <th>Assigned To</th><th>Lead</th><th>Remarks</th><th>Actions</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          individualData.forEach((person, index) => {
            html += `
              <tr>
                <td><input class="filter-input" value="${person.First || ''}" onchange="updateDataItem('individuals', ${index}, 'First', this.value)"></td>
                <td><input class="filter-input" value="${person.Last || ''}" onchange="updateDataItem('individuals', ${index}, 'Last', this.value)"></td>
                <td><input class="filter-input" value="${person.Phone || ''}" onchange="updateDataItem('individuals', ${index}, 'Phone', this.value)"></td>
                <td><input class="filter-input" value="${person.Phone2 || ''}" onchange="updateDataItem('individuals', ${index}, 'Phone2', this.value)"></td>
                <td><input class="filter-input" value="${person.Email || ''}" onchange="updateDataItem('individuals', ${index}, 'Email', this.value)"></td>
                <td><select class="filter-input" onchange="updateDataItem('individuals', ${index}, 'Agency', this.value)">${createSelectOptions(agencies, person.Agency)}</select></td>
                <td><select class="filter-input" onchange="updateDataItem('individuals', ${index}, 'Unit', this.value)">${createSelectOptions(units, person.Unit)}</select></td>
                <td><select class="filter-input" onchange="updateDataItem('individuals', ${index}, 'Location', this.value)">${createSelectOptions(locations, person.Location)}</select></td>
                <td><select class="filter-input" onchange="updateDataItem('individuals', ${index}, 'Title', this.value)">${createSelectOptions(titles, person.Title)}</select></td>
                <td><select class="filter-input" onchange="updateDataItem('individuals', ${index}, 'ICSRole', this.value)">${createSelectOptions(icsRoles, person.ICSRole)}</select></td>
                <td><input class="filter-input" value="${person.AssignedTo || ''}" onchange="updateDataItem('individuals', ${index}, 'AssignedTo', this.value)"></td>
                <td><select class="filter-input" onchange="updateDataItem('individuals', ${index}, 'Lead', this.value)">
                    <option value="Yes" ${person.Lead === 'Yes' ? 'selected' : ''}>Yes</option>
                    <option value="No" ${person.Lead === 'No' ? 'selected' : ''}>No</option>
                  </select></td>
                <td><input class="filter-input" value="${person.Remarks || ''}" onchange="updateDataItem('individuals', ${index}, 'Remarks', this.value)"></td>
                <td><button class="delete-btn" onclick="removeDataItem('individuals', ${index})">Delete</button></td>
              </tr>
            `;
          });
          break;
          
        case 'resources':
          html += `
            <table class="modal-table">
              <thead>
                <tr>
                  <th>Resource Type</th><th>Resource Name</th><th>Leader</th>
                  <th>Assigned</th><th>Status</th><th>Location</th><th>Remarks</th><th>Actions</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          resourceData.forEach((resource, index) => {
            const leaders = individualData.map(i => `${i.First} ${i.Last}`);
            html += `
              <tr>
                <td><select class="filter-input" onchange="updateDataItem('resources', ${index}, 'ResourceType', this.value)">${createSelectOptions(resourceTypes, resource.ResourceType)}</select></td>
                <td><input class="filter-input" value="${resource.ResourceName || ''}" onchange="updateDataItem('resources', ${index}, 'ResourceName', this.value)"></td>
                <td><select class="filter-input" onchange="updateDataItem('resources', ${index}, 'Leader', this.value)">
                    <option value="">Select Leader</option>
                    ${createSelectOptions(leaders, resource.Leader)}
                  </select></td>
                <td><input class="filter-input" type="number" value="${resource.Assigned || 1}" onchange="updateDataItem('resources', ${index}, 'Assigned', this.value)"></td>
                <td><select class="filter-input" onchange="updateDataItem('resources', ${index}, 'Status', this.value)">${createSelectOptions(statuses, resource.Status)}</select></td>
                <td><select class="filter-input" onchange="updateDataItem('resources', ${index}, 'Location', this.value)">${createSelectOptions(locations, resource.Location)}</select></td>
                <td><input class="filter-input" value="${resource.Remarks || ''}" onchange="updateDataItem('resources', ${index}, 'Remarks', this.value)"></td>
                <td><button class="delete-btn" onclick="removeDataItem('resources', ${index})">Delete</button></td>
              </tr>
            `;
          });
          break;
          
        case 'aviation':
          html += `
            <table class="modal-table">
              <thead>
                <tr>
                  <th>Type</th><th>Aircraft Type</th><th>Resource</th><th>Status</th><th>Location</th><th>On/Off</th><th>Actions</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          // Flatten aviation data for display
          const aviationFlat = [];
          Object.entries(aviationData).forEach(([type, resources]) => {
            resources.forEach((resource, resourceIndex) => {
              aviationFlat.push({...resource, WingType: type, originalIndex: resourceIndex});
            });
          });
          
          aviationFlat.forEach((aircraft, index) => {
            html += `
              <tr>
                <td><select class="filter-input" onchange="updateAviationItem(${index}, 'WingType', this.value)">
                    <option value="Rotor Wing" ${aircraft.WingType === 'Rotor Wing' ? 'selected' : ''}>Rotor Wing</option>
                    <option value="Fixed Wing" ${aircraft.WingType === 'Fixed Wing' ? 'selected' : ''}>Fixed Wing</option>
                  </select></td>
                <td><input class="filter-input" value="${aircraft.Type || ''}" onchange="updateAviationItem(${index}, 'Type', this.value)"></td>
                <td><input class="filter-input" value="${aircraft.Resource || ''}" onchange="updateAviationItem(${index}, 'Resource', this.value)"></td>
                <td><select class="filter-input" onchange="updateAviationItem(${index}, 'Status', this.value)">
                    <option value="Available" ${aircraft.Status === 'Available' ? 'selected' : ''}>Available</option>
                    <option value="Unavailable" ${aircraft.Status === 'Unavailable' ? 'selected' : ''}>Unavailable</option>
                    <option value="Committed" ${aircraft.Status === 'Committed' ? 'selected' : ''}>Committed</option>
                    <option value="Out of Service" ${aircraft.Status === 'Out of Service' ? 'selected' : ''}>Out of Service</option>
                  </select></td>
                <td><select class="filter-input" onchange="updateAviationItem(${index}, 'Location', this.value)">${createSelectOptions(locations, aircraft.Location)}</select></td>
                <td><input class="filter-input" value="${aircraft.OnOff || ''}" onchange="updateAviationItem(${index}, 'OnOff', this.value)"></td>
                <td><button class="delete-btn" onclick="removeAviationItem(${index})">Delete</button></td>
              </tr>
            `;
          });
          break;
      }
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function updateDataItem(dataType, index, field, value) {
      switch(dataType) {
        case 'individuals':
          if (individualData[index]) {
            individualData[index][field] = value;
          }
          break;
        case 'resources':
          if (resourceData[index]) {
            resourceData[index][field] = value;
          }
          break;
      }
    }

    function updateAviationItem(flatIndex, field, value) {
      // Need to rebuild aviation data structure
      const aviationFlat = [];
      Object.entries(aviationData).forEach(([type, resources]) => {
        resources.forEach((resource, resourceIndex) => {
          aviationFlat.push({...resource, WingType: type, originalIndex: resourceIndex, originalType: type});
        });
      });
      
      if (aviationFlat[flatIndex]) {
        aviationFlat[flatIndex][field] = value;
        
        // Rebuild aviationData structure
        const newAviationData = { "Rotor Wing": [], "Fixed Wing": [] };
        aviationFlat.forEach(item => {
          const wingType = item.WingType;
          const aircraftData = {
            Type: item.Type,
            Resource: item.Resource,
            Status: item.Status,
            Location: item.Location,
            OnOff: item.OnOff
          };
          
          if (wingType === 'Rotor Wing') {
            newAviationData["Rotor Wing"].push(aircraftData);
          } else {
            newAviationData["Fixed Wing"].push(aircraftData);
          }
        });
        
        aviationData = newAviationData;
      }
    }

    function removeDataItem(dataType, index) {
      if (confirm('Are you sure you want to delete this item?')) {
        switch(dataType) {
          case 'individuals':
            individualData.splice(index, 1);
            break;
          case 'resources':
            resourceData.splice(index, 1);
            break;
        }
        loadDataContent(currentDataTab);
      }
    }

    function removeAviationItem(flatIndex) {
      if (confirm('Are you sure you want to delete this aircraft?')) {
        const aviationFlat = [];
        Object.entries(aviationData).forEach(([type, resources]) => {
          resources.forEach((resource, resourceIndex) => {
            aviationFlat.push({...resource, WingType: type});
          });
        });
        
        aviationFlat.splice(flatIndex, 1);
        
        // Rebuild aviationData structure
        const newAviationData = { "Rotor Wing": [], "Fixed Wing": [] };
        aviationFlat.forEach(item => {
          const wingType = item.WingType;
          const aircraftData = {
            Type: item.Type,
            Resource: item.Resource,
            Status: item.Status,
            Location: item.Location,
            OnOff: item.OnOff
          };
          
          if (wingType === 'Rotor Wing') {
            newAviationData["Rotor Wing"].push(aircraftData);
          } else {
            newAviationData["Fixed Wing"].push(aircraftData);
          }
        });
        
        aviationData = newAviationData;
        loadDataContent('aviation');
      }
    }

    function addDataRow() {
      switch(currentDataTab) {
        case 'individuals':
          individualData.push({
            First: '', Last: '', Phone: '', Phone2: '', Email: '',
            Agency: 'USFS', Unit: 'COFMS', Location: 'Cascade Division',
            Title: '', ICSRole: 'FFT1', AssignedTo: '', Lead: 'No', Remarks: ''
          });
          break;
        case 'resources':
          resourceData.push({
            ResourceType: 'Duty Officer', ResourceName: '', Leader: '',
            Assigned: 1, Status: 'In Service', Location: 'Cascade Division', Remarks: ''
          });
          break;
        case 'aviation':
          aviationData["Rotor Wing"].push({
            Type: 'HEL T1', Resource: '', Status: 'Available', Location: 'Redmond', OnOff: '0800-2000'
          });
          break;
      }
      loadDataContent(currentDataTab);
    }

    function saveDataChanges() {
      renderPage();
      alert('All changes saved! Use CSV controls to download updated files.');
      closeModal('dataManagerModal');
    }
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // Initialize - Load JSON files then render (with fallback)
    window.addEventListener('load', () => {
      console.log('Page DOM loaded, initializing...');
      
      // Set a fallback timer in case JSON loading takes too long
      setTimeout(() => {
        if (!document.getElementById('staffing-container').hasChildNodes()) {
          console.log('Fallback: Rendering with sample data after timeout');
          renderPage();
        }
      }, 5000); // 5 second fallback
      
      // Try to load JSON files
      loadJSONFiles();
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }

    function renderPage() {
      const staffingContainer = document.getElementById('staffing-container');
      const aviationContainer = document.getElementById('aviation-container');
      const dutyOfficerDiv = document.getElementById('cofms-duty-officer');

      // Set COFMS duty officer block
      dutyOfficerDiv.innerHTML = getCOFMSDutyOfficer();

      // Clear and rebuild staffing container
      staffingContainer.innerHTML = '';
      const staffingData = getStaffingData();

      staffingData.forEach(division => {
        const section = document.createElement('div');
        section.className = 'division-section';

        const resourcesHTML = division.resources
          .filter(shouldShowResource)
          .map(r => `
            <tr class="${getStatusClass(r.status)}" title="${r.remarks || ''}">
              <td>${r.type}</td>
              <td>${r.name}</td>
              <td>${r.leader}</td>
              <td>${r.assigned}</td>
              <td>${r.status}</td>
              <td>${r.location}</td>
              <td>${r.remarks}</td>
            </tr>
          `).join('');

        section.innerHTML = `
          <div class="division-header">
            <h3>${division.name}</h3>
            <div class="division-meta">
              Last Modified: ${division.lastModified}<br>
              ${division.agencyAdmins.length ? `Agency Admin(s):<br>${division.agencyAdmins.join('<br>')}` : ''}
            </div>
          </div>
          ${division.dutyOfficer ? `<div class="duty-info"><strong>Duty Officer:</strong> ${division.dutyOfficer}</div>` : ''}
          <table class="division-table">
            <thead>
              <tr><th>Type</th><th>Resource</th><th>Leader</th><th>Assigned</th><th>Status</th><th>Location</th><th>Remarks</th></tr>
            </thead>
            <tbody>
              ${resourcesHTML || `<tr><td colspan="7"><em>No resources shown with current filters.</em></td></tr>`}
            </tbody>
          </table>
          <button class="update-btn" onclick="toggleDivisionEdit(this.parentElement, ${JSON.stringify(division).replace(/"/g, '&quot;')})">✎ Edit</button>
        `;

        staffingContainer.appendChild(section);
      });

      // Rebuild aviation section
      aviationContainer.innerHTML = '';
      Object.entries(aviationData).forEach(([wingType, resources]) => {
        const section = document.createElement('div');
        section.className = 'aviation-table-section';
        section.innerHTML = `
          <h3>${wingType}</h3>
          <table class="aviation-table">
            <thead>
              <tr><th>Type</th><th>Resource</th><th>Status</th><th>Location</th><th>On/Off</th></tr>
            </thead>
            <tbody>
              ${resources.map(r => `
                <tr class="${getStatusClass(r.Status)}" title="${r.Type || ''}">
                  <td>${r.Type}</td>
                  <td>${r.Resource}</td>
                  <td>${r.Status}</td>
                  <td>${r.Location}</td>
                  <td>${r.OnOff}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        aviationContainer.appendChild(section);
      });
    }


  </script>
</body>
</html>